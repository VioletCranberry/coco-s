---
phase: 08-custom-language-definitions-and-file-routing
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - src/cocosearch/indexer/embedder.py
  - src/cocosearch/indexer/flow.py
  - src/cocosearch/indexer/__init__.py
  - tests/indexer/test_embedder.py
  - tests/indexer/test_flow.py
autonomous: true

must_haves:
  truths:
    - "Dockerfile and Containerfile files are routed to the 'dockerfile' language spec"
    - "Dockerfile.dev and Dockerfile.production variants are routed to 'dockerfile'"
    - "HCL files (.tf, .hcl, .tfvars) continue to route by extension"
    - "Shell files (.sh, .bash, .zsh) continue to route by extension"
    - "Non-DevOps files route identically to v1.1 (extension-based)"
    - "SplitRecursively receives custom_languages parameter with all three language specs"
    - "Existing Tree-sitter-supported files are unaffected by custom language additions"
  artifacts:
    - path: "src/cocosearch/indexer/embedder.py"
      provides: "extract_language function with Dockerfile filename-based routing"
      exports: ["extract_language", "extract_extension", "code_to_embedding"]
    - path: "src/cocosearch/indexer/flow.py"
      provides: "Flow with custom_languages passed to SplitRecursively and extract_language for routing"
      contains: "custom_languages"
    - path: "tests/indexer/test_embedder.py"
      provides: "Tests for extract_language function"
      contains: "TestExtractLanguage"
  key_links:
    - from: "src/cocosearch/indexer/flow.py"
      to: "src/cocosearch/indexer/languages.py"
      via: "import DEVOPS_CUSTOM_LANGUAGES"
      pattern: "from cocosearch.indexer.languages import"
    - from: "src/cocosearch/indexer/flow.py"
      to: "src/cocosearch/indexer/embedder.py"
      via: "import extract_language"
      pattern: "extract_language"
    - from: "src/cocosearch/indexer/flow.py"
      to: "cocoindex.functions.SplitRecursively"
      via: "custom_languages parameter"
      pattern: "custom_languages=DEVOPS_CUSTOM_LANGUAGES"
---

<objective>
Create the `extract_language` routing function and wire custom languages into the indexing flow.

Purpose: Without language routing, extensionless files like `Dockerfile` fall through to plain-text chunking. Without wiring `custom_languages` into `SplitRecursively`, the language specs from Plan 01 are unused. This plan completes the Phase 08 integration: DevOps files are detected, routed to the correct language spec, and chunked at structural boundaries.

Output: Enhanced `embedder.py` with `extract_language`, updated `flow.py` with custom_languages integration, updated `__init__.py` exports, and comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-custom-language-definitions-and-file-routing/08-RESEARCH.md
@.planning/phases/08-custom-language-definitions-and-file-routing/08-01-SUMMARY.md
@src/cocosearch/indexer/embedder.py
@src/cocosearch/indexer/flow.py
@src/cocosearch/indexer/__init__.py
@src/cocosearch/indexer/languages.py
@tests/indexer/test_embedder.py
@tests/indexer/test_flow.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extract_language function and update routing</name>
  <files>src/cocosearch/indexer/embedder.py, tests/indexer/test_embedder.py</files>
  <action>
Add a new `extract_language` function to `src/cocosearch/indexer/embedder.py`. Keep the existing `extract_extension` function unchanged (backward compatibility -- it's used elsewhere and exported in `__init__.py`).

```python
@cocoindex.op.function()
def extract_language(filename: str) -> str:
    """Extract language identifier for SplitRecursively routing.

    Checks filename patterns first (for extensionless files like Dockerfile),
    then falls back to extension-based detection. This ensures correct
    language routing for DevOps files that use non-standard naming.

    Args:
        filename: File name or path.

    Returns:
        Language identifier string (e.g., "dockerfile", "py", "tf").
        Returns empty string if no language detected.
    """
    basename = os.path.basename(filename)

    # Filename-based routing (extensionless files)
    if basename == "Containerfile" or basename.startswith("Dockerfile"):
        return "dockerfile"

    # Extension-based routing (standard behavior, same as extract_extension)
    _, ext = os.path.splitext(filename)
    return ext[1:] if ext else ""
```

Key design decisions:
- `basename.startswith("Dockerfile")` catches `Dockerfile`, `Dockerfile.dev`, `Dockerfile.production`, etc.
- Exact match for `Containerfile` (not startsWith, to avoid false positives).
- Falls back to extension-based routing for all other files -- identical behavior to `extract_extension` for non-DevOps files.
- Decorated with `@cocoindex.op.function()` so it can be used as a CocoIndex transform.

Update `tests/indexer/test_embedder.py` -- add a new test class `TestExtractLanguage`:

Test cases:
- `extract_language("main.tf")` returns `"tf"` (HCL via extension)
- `extract_language("variables.tfvars")` returns `"tfvars"` (HCL via extension)
- `extract_language("config.hcl")` returns `"hcl"` (HCL via extension)
- `extract_language("Dockerfile")` returns `"dockerfile"` (filename-based)
- `extract_language("Dockerfile.dev")` returns `"dockerfile"` (filename prefix)
- `extract_language("Dockerfile.production")` returns `"dockerfile"` (filename prefix)
- `extract_language("Containerfile")` returns `"dockerfile"` (exact match)
- `extract_language("deploy.sh")` returns `"sh"` (Bash via extension)
- `extract_language("build.bash")` returns `"bash"` (Bash via extension)
- `extract_language("test.py")` returns `"py"` (non-DevOps, unchanged)
- `extract_language("app.js")` returns `"js"` (non-DevOps, unchanged)
- `extract_language("Makefile")` returns `""` (no extension, not a Dockerfile)
- `extract_language("/path/to/Dockerfile")` returns `"dockerfile"` (full path)
- `extract_language("/path/to/Dockerfile.dev")` returns `"dockerfile"` (full path with variant)
- `extract_language("/infra/main.tf")` returns `"tf"` (full path)

Keep all existing `TestExtractExtension` and `TestCodeToEmbedding` tests unchanged.
  </action>
  <verify>
Run: `cd /Users/fzhdanov/GIT/personal/coco-s && python -m pytest tests/indexer/test_embedder.py -v`
All tests pass (both old and new).
Also verify: `python -c "from cocosearch.indexer.embedder import extract_language; print(extract_language('Dockerfile'))"` prints `dockerfile`.
  </verify>
  <done>
extract_language function correctly routes Dockerfile/Containerfile by filename and all other files by extension. All embedder tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire custom_languages into flow and update exports</name>
  <files>src/cocosearch/indexer/flow.py, src/cocosearch/indexer/__init__.py, tests/indexer/test_flow.py</files>
  <action>
Modify `src/cocosearch/indexer/flow.py` with TWO changes:

**Change 1:** Add imports at the top:
```python
from cocosearch.indexer.languages import DEVOPS_CUSTOM_LANGUAGES
```
Also update the existing import line to include `extract_language`:
```python
from cocosearch.indexer.embedder import code_to_embedding, extract_extension, extract_language
```

**Change 2:** In `create_code_index_flow()`, make two modifications:

(a) Pass `custom_languages` to `SplitRecursively` constructor:
```python
# Chunk using Tree-sitter + custom DevOps languages (SplitRecursively)
file["chunks"] = file["content"].transform(
    cocoindex.functions.SplitRecursively(
        custom_languages=DEVOPS_CUSTOM_LANGUAGES,
    ),
    language=file["extension"],  # Changed in step (b) below
    chunk_size=chunk_size,
    chunk_overlap=chunk_overlap,
)
```

(b) Replace `extract_extension` with `extract_language` for the language detection step:
```python
# Extract language identifier for routing (handles extensionless files like Dockerfile)
file["extension"] = file["filename"].transform(extract_language)
```
Note: The field is still called `extension` to minimize changes (it's used as the `language=` parameter). The variable name is a slight misnomer but avoids touching the `language=file["extension"]` line in the SplitRecursively call. Add a comment explaining this.

**Do NOT change:** chunk_size default parameter (keep 1000). The research recommends 2000 for DevOps files, but changing the default would affect ALL files including non-DevOps. This decision should be made by the user via `.cocosearch.yaml` config. The 2000 recommendation can be documented, but the code default stays at 1000. Do NOT add metadata extraction steps here -- that is Phase 2 (metadata extraction).

**Update `src/cocosearch/indexer/__init__.py`:**
Add `extract_language` to the imports and `__all__` list:
```python
from cocosearch.indexer.embedder import code_to_embedding, extract_extension, extract_language
```
And in `__all__`:
```python
"extract_language",
```

**Update `tests/indexer/test_flow.py`:**
Read the existing test file first. Add tests that verify:
- `create_code_index_flow` imports and uses `DEVOPS_CUSTOM_LANGUAGES` (check that the function can be called without errors -- this is a smoke test since the actual CocoIndex runtime isn't available in unit tests)
- The import chain works: `from cocosearch.indexer.languages import DEVOPS_CUSTOM_LANGUAGES` and `from cocosearch.indexer.embedder import extract_language` are importable
- `from cocosearch.indexer import extract_language` works (via __init__.py)

If the existing test_flow.py already mocks CocoIndex, follow that pattern. If it tests at integration level, add a simple import/smoke test class.
  </action>
  <verify>
Run: `cd /Users/fzhdanov/GIT/personal/coco-s && python -m pytest tests/indexer/ -v`
All indexer tests pass (test_languages.py, test_config.py, test_embedder.py, test_flow.py, test_file_filter.py, test_progress.py).

Also run full test suite: `cd /Users/fzhdanov/GIT/personal/coco-s && python -m pytest -v`
All tests pass.

Verify imports: `python -c "from cocosearch.indexer import extract_language; print('OK')"`
Verify flow module loads: `python -c "from cocosearch.indexer.flow import create_code_index_flow; print('OK')"`
  </verify>
  <done>
flow.py passes DEVOPS_CUSTOM_LANGUAGES to SplitRecursively constructor. flow.py uses extract_language instead of extract_extension for language routing. __init__.py exports extract_language. All tests pass across the entire test suite.
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/ -v` -- full test suite passes
2. `python -c "from cocosearch.indexer.flow import create_code_index_flow; print('OK')"` -- flow module loads without import errors
3. `python -c "from cocosearch.indexer import extract_language; print(extract_language('Dockerfile'))"` -- prints "dockerfile"
4. `python -c "from cocosearch.indexer import extract_language; print(extract_language('main.tf'))"` -- prints "tf"
5. `python -c "from cocosearch.indexer import extract_language; print(extract_language('test.py'))"` -- prints "py" (non-DevOps unchanged)
6. Inspect flow.py to confirm `custom_languages=DEVOPS_CUSTOM_LANGUAGES` is present in SplitRecursively constructor
7. Inspect flow.py to confirm `extract_language` is used instead of `extract_extension` for file routing
</verification>

<success_criteria>
- extract_language correctly routes Dockerfile/Containerfile by filename prefix/exact match
- extract_language correctly routes all other files by extension (identical to extract_extension)
- flow.py passes custom_languages=DEVOPS_CUSTOM_LANGUAGES to SplitRecursively
- flow.py uses extract_language for language detection
- __init__.py exports extract_language
- All existing tests continue to pass (REQ-06: non-DevOps files unaffected)
- New tests cover all Dockerfile variants, standard extensions, and edge cases
- No regressions in any module
</success_criteria>

<output>
After completion, create `.planning/phases/08-custom-language-definitions-and-file-routing/08-02-SUMMARY.md`
</output>
