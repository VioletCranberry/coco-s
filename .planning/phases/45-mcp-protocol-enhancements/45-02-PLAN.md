---
phase: 45-mcp-protocol-enhancements
plan: 02
type: execute
wave: 2
depends_on: ["45-01"]
files_modified:
  - src/cocosearch/mcp/server.py
autonomous: true

must_haves:
  truths:
    - "search_code is async and accepts ctx: Context parameter"
    - "search_code calls _detect_project(ctx) instead of find_project_root() when index_name is None"
    - "search_code includes a hint appended to output on every call where source is 'env' or 'cwd' (not a one-time mechanism)"
    - "search_code uses find_project_root to walk up to git root after _detect_project returns a path"
    - "list_indexes remains unchanged (does not need project detection)"
    - "index_stats remains unchanged (does not need project detection)"
    - "clear_index remains unchanged (does not need project detection)"
    - "index_codebase remains unchanged (takes explicit path)"
    - "register_roots_notification is called during server setup"
    - "The old top-level find_project_root import is removed (replaced by _detect_project + local re-import)"
    - "COCOSEARCH_PROJECT_PATH env var check is removed from search_code body (handled by _detect_project)"
  artifacts:
    - path: "src/cocosearch/mcp/server.py"
      provides: "Async MCP tools with Context-based project detection"
      min_lines: 400
  key_links:
    - from: "src/cocosearch/mcp/server.py"
      to: "src/cocosearch/mcp/project_detection.py"
      via: "import and call _detect_project(ctx)"
      pattern: "from cocosearch\\.mcp\\.project_detection import"
    - from: "src/cocosearch/mcp/server.py"
      to: "mcp.server.fastmcp.Context"
      via: "ctx: Context parameter on search_code"
      pattern: "ctx: Context"
    - from: "src/cocosearch/mcp/server.py"
      to: "cocosearch.management.context.find_project_root"
      via: "local import inside search_code function body for git-root walking"
      pattern: "from cocosearch\\.management\\.context import find_project_root"
---

<objective>
Convert the search_code MCP tool to async with Context injection, integrate _detect_project() for protocol-correct project detection, and register the roots notification handler.

Purpose: This replaces the old sync find_project_root() / COCOSEARCH_PROJECT_PATH env var approach with the protocol-standard Roots capability, while maintaining backward compatibility through the priority chain fallback.

Output: Updated `server.py` where search_code is async, uses Context for detection, and the roots notification handler is registered at server setup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/45-mcp-protocol-enhancements/45-CONTEXT.md
@.planning/phases/45-mcp-protocol-enhancements/45-RESEARCH.md
@.planning/phases/45-mcp-protocol-enhancements/45-01-SUMMARY.md
@src/cocosearch/mcp/server.py
@src/cocosearch/mcp/project_detection.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert search_code to async with Context-based detection</name>
  <files>src/cocosearch/mcp/server.py</files>
  <action>
Modify `src/cocosearch/mcp/server.py` to integrate the new project detection system. This involves several targeted changes:

**1. Update imports (top of file):**
- ADD: `from mcp.server.fastmcp import Context` (for Context type annotation)
- ADD: `from cocosearch.mcp.project_detection import _detect_project, register_roots_notification`
- REMOVE: `find_project_root` from the `cocosearch.management` import (no longer used at top level in this file)
- Keep all other existing imports unchanged

**2. Register roots notification handler (after `mcp = FastMCP("cocosearch")` line):**
- Add: `register_roots_notification(mcp)` immediately after the FastMCP instance creation
- This sets up the roots/list_changed notification handler on the low-level server

**3. Convert `search_code` from sync to async:**
- Change `def search_code(...)` to `async def search_code(...)`
- Add `ctx: Context` parameter after the existing parameters (FastMCP auto-injects it):
  ```python
  async def search_code(
      query: Annotated[str, Field(description="Natural language search query")],
      ctx: Context,
      index_name: Annotated[...] = None,
      limit: Annotated[...] = 10,
      ... # all other params unchanged
  ) -> list[dict]:
  ```

**4. Replace project detection logic in search_code:**

REMOVE the old detection block (approximately lines 211-237):
```python
# REMOVE: project_path_env = os.environ.get("COCOSEARCH_PROJECT_PATH")
# REMOVE: the entire if/else block using find_project_root and project_path_env
```

REPLACE WITH new detection using `_detect_project(ctx)`. IMPORTANT: `_detect_project` always returns a valid Path (never None) because cwd is the unconditional fallback. Do NOT add a `if detected_path is None` guard -- it is unreachable dead code.

```python
    if index_name is None:
        detected_path, source = await _detect_project(ctx)

        root_path = detected_path

        # Use find_project_root to walk up to actual git/config root from detected path
        from cocosearch.management.context import find_project_root
        project_root, detection_method = find_project_root(detected_path)
        if project_root is not None:
            root_path = project_root

        # Resolve index name using priority chain
        index_name = resolve_index_name(root_path, detection_method if project_root else None)
        logger.info(f"Auto-detected index: {index_name} from {root_path} (source: {source})")
```

CRITICAL: The local import MUST use `from cocosearch.management.context import find_project_root` (the exact module path). This is the mock target for tests in Plan 03. Do NOT use `from cocosearch.management import find_project_root` -- that goes through `__init__.py` re-exports and creates ambiguous mock targets.

When `find_project_root` returns `(None, None)` (meaning the detected_path is not inside a recognized project), the behavior depends on `resolve_index_name` with `detection_method=None`. If that produces an error or an index that doesn't exist, the existing "Check if index exists" block downstream will handle it. No special None handling needed here.

Keep the existing "Check if index exists" block, collision detection block, and all search execution code UNCHANGED.

**5. Add hint for non-roots clients:**

After the search results are built (after the `output` list is fully constructed but before the staleness check), add a hint when detection source was not "roots":
```python
        # Add hint for clients without Roots support
        if source in ("env", "cwd"):
            output.append({
                "type": "hint",
                "message": "Tip: Use Claude Code for automatic project detection via MCP Roots.",
            })
```

Note: This hint is appended on EVERY call where source is "env" or "cwd". There is no one-time suppression mechanism -- keeping it simple. The hint is lightweight and serves as a gentle nudge.

To make the `source` variable available at the hint insertion point, set a tracking variable at the top of the function:
```python
    auto_detected_source = None  # Track detection source for hint
```
Set it to `source` inside the `if index_name is None` block, then check `if auto_detected_source in ("env", "cwd")` after building results.

**6. Do NOT convert other tools:**
- `list_indexes`, `index_stats`, `clear_index`, `index_codebase` -- leave as sync `def` functions
- These tools either don't need project detection (list/stats/clear take explicit index_name) or take explicit path (index_codebase)
- Only search_code needs Context because only it auto-detects the project

**Important: What to preserve unchanged:**
- All tool parameter annotations (Annotated, Field descriptions)
- The `@mcp.tool()` decorators
- The search execution logic (cocoindex.init, search call, result formatting)
- The context expansion logic (smart_context, context_before/after)
- The staleness check at the end
- All custom routes (/health, /dashboard, /api/stats)
- The run_server function
- The _get_treesitter_language helper
  </action>
  <verify>
1. `python -c "from cocosearch.mcp.server import search_code; import asyncio; assert asyncio.iscoroutinefunction(search_code)"` -- search_code is async
2. `python -c "import inspect; from cocosearch.mcp.server import search_code; sig = inspect.signature(search_code); assert 'ctx' in sig.parameters"` -- ctx parameter exists
3. `python -c "from cocosearch.mcp.server import list_indexes; import asyncio; assert not asyncio.iscoroutinefunction(list_indexes)"` -- list_indexes remains sync
4. `python -c "import inspect; from cocosearch.mcp.server import search_code; params = list(inspect.signature(search_code).parameters.keys()); print(params)"` -- verify parameter order
5. Manually verify that `find_project_root` is no longer imported at top-level from management in server.py (grep for it)
6. Grep for `from cocosearch.management.context import find_project_root` inside the search_code function body to confirm exact import path
  </verify>
  <done>
- search_code is `async def` with `ctx: Context` parameter
- search_code calls `await _detect_project(ctx)` for project detection
- No unreachable `if detected_path is None` guard (removed -- _detect_project always returns a valid Path)
- Local import uses exact path `from cocosearch.management.context import find_project_root`
- Old `find_project_root` / `COCOSEARCH_PROJECT_PATH` env var logic removed from search_code
- register_roots_notification(mcp) called at module level after FastMCP creation
- Hint appended for env/cwd detection sources on every applicable call
- All other tools (list_indexes, index_stats, clear_index, index_codebase) unchanged
- All non-detection logic in search_code preserved (search, context expansion, staleness)
  </done>
</task>

</tasks>

<verification>
1. `python -c "from cocosearch.mcp.server import search_code, list_indexes, index_stats, clear_index, index_codebase; print('all tools import OK')"` -- all tools importable
2. `python -c "import asyncio; from cocosearch.mcp.server import search_code; assert asyncio.iscoroutinefunction(search_code); print('search_code is async')"` -- async verified
3. `python -c "import asyncio; from cocosearch.mcp.server import list_indexes; assert not asyncio.iscoroutinefunction(list_indexes); print('list_indexes is sync')"` -- sync verified
4. `grep -c "find_project_root" src/cocosearch/mcp/server.py` -- should show only the local import inside the function body (from cocosearch.management.context)
5. `grep "_detect_project" src/cocosearch/mcp/server.py` -- should find import and usage
6. `grep "register_roots_notification" src/cocosearch/mcp/server.py` -- should find import and call
7. `grep "detected_path is None" src/cocosearch/mcp/server.py` -- should return 0 matches (no dead code)
</verification>

<success_criteria>
- search_code is async with Context parameter and uses _detect_project for all project detection
- No unreachable None guard on detected_path (dead code eliminated)
- Local find_project_root import uses exact path `cocosearch.management.context` for clean mock targeting
- The old COCOSEARCH_PROJECT_PATH direct env var check is removed from search_code (handled by _detect_project)
- find_project_root is no longer imported at top level from management module in server.py
- register_roots_notification is called at module level
- All other tools remain sync and unchanged
- Hint message appears for non-roots detection sources on every applicable call
</success_criteria>

<output>
After completion, create `.planning/phases/45-mcp-protocol-enhancements/45-02-SUMMARY.md`
</output>
