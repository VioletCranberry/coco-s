---
phase: 06-test-coverage
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_cli.py
autonomous: true

must_haves:
  truths:
    - "pytest runs CLI tests without real services"
    - "derive_index_name sanitizes paths correctly"
    - "Commands return 0 on success, 1 on error"
    - "JSON output is parseable, pretty output is readable"
    - "Error cases output error messages and return 1"
  artifacts:
    - path: "tests/test_cli.py"
      provides: "CLI command tests"
      min_lines: 150
  key_links:
    - from: "tests/test_cli.py"
      to: "pytest capsys"
      via: "stdout/stderr capture"
      pattern: "capsys\\.readouterr"
    - from: "tests/test_cli.py"
      to: "tests/fixtures/db.py"
      via: "mock_db_pool for search/list/stats commands"
      pattern: "mock_db_pool"
---

<objective>
Create comprehensive tests for the CLI module covering all commands, output formatting, and error handling.

Purpose: Fulfill TEST-CLI-01 through TEST-CLI-03 requirements. Test command handlers directly with mocked dependencies.
Output: tests/test_cli.py with tests for all CLI commands
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-coverage/06-CONTEXT.md
@.planning/phases/06-test-coverage/06-RESEARCH.md
@.planning/phases/05-test-infrastructure/05-02-SUMMARY.md
@.planning/phases/05-test-infrastructure/05-03-SUMMARY.md

# Source file to test
@src/cocosearch/cli.py

# Existing fixtures
@tests/conftest.py
@tests/fixtures/db.py
@tests/fixtures/ollama.py
@tests/fixtures/data.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tests for derive_index_name and parse_query_filters</name>
  <files>
    tests/test_cli.py
  </files>
  <action>
Create tests/test_cli.py with tests for utility functions:

```python
"""Tests for cocosearch CLI."""
import argparse
import json
import pytest
from unittest.mock import patch, MagicMock

from cocosearch.cli import (
    derive_index_name,
    parse_query_filters,
    index_command,
    search_command,
    list_command,
    stats_command,
    clear_command,
)


class TestDeriveIndexName:
    """Tests for derive_index_name function."""

    def test_simple_directory(self):
        """Extracts and sanitizes directory name."""
        assert derive_index_name("/home/user/MyProject") == "myproject"

    def test_directory_with_hyphens(self):
        """Converts hyphens to underscores."""
        assert derive_index_name("/tmp/test-repo") == "test_repo"

    def test_trailing_slash(self):
        """Handles trailing slash."""
        assert derive_index_name("/home/user/project/") == "project"

    def test_collapses_multiple_underscores(self):
        """Collapses multiple consecutive underscores."""
        assert derive_index_name("/path/my--project") == "my_project"

    def test_empty_result_returns_index(self):
        """Returns 'index' when name would be empty."""
        # Root path or all-special-char paths
        assert derive_index_name("/") == "root"


class TestParseQueryFilters:
    """Tests for parse_query_filters function."""

    def test_no_filters(self):
        """Returns original query when no filters."""
        query, lang = parse_query_filters("find auth code")
        assert query == "find auth code"
        assert lang is None

    def test_lang_filter(self):
        """Extracts lang:xxx pattern."""
        query, lang = parse_query_filters("find auth code lang:python")
        assert query == "find auth code"
        assert lang == "python"

    def test_lang_filter_middle(self):
        """Handles lang filter in middle of query."""
        query, lang = parse_query_filters("find lang:typescript auth code")
        assert query == "find  auth code"  # Note double space from removal
        assert lang == "typescript"
```
  </action>
  <verify>pytest tests/test_cli.py::TestDeriveIndexName tests/test_cli.py::TestParseQueryFilters -v --tb=short</verify>
  <done>Utility function tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create tests for index, search, and list commands</name>
  <files>
    tests/test_cli.py
  </files>
  <action>
Append to tests/test_cli.py:

```python
class TestIndexCommand:
    """Tests for index_command."""

    def test_invalid_path_returns_error(self, capsys):
        """Returns 1 for nonexistent path."""
        args = argparse.Namespace(
            path="/nonexistent/path",
            name=None,
            include=None,
            exclude=None,
            no_gitignore=False,
        )
        result = index_command(args)
        assert result == 1
        captured = capsys.readouterr()
        assert "Error" in captured.out
        assert "does not exist" in captured.out

    def test_valid_path_runs_indexing(self, capsys, tmp_codebase):
        """Returns 0 for valid path with mocked indexing."""
        with patch("cocosearch.cli.run_index") as mock_run:
            mock_run.return_value = MagicMock(stats={"files": {"num_insertions": 1}})
            with patch("cocosearch.cli.IndexingProgress"):
                args = argparse.Namespace(
                    path=str(tmp_codebase),
                    name="testindex",
                    include=None,
                    exclude=None,
                    no_gitignore=False,
                )
                result = index_command(args)
        assert result == 0


class TestSearchCommand:
    """Tests for search_command."""

    def test_requires_query_without_interactive(self, capsys):
        """Returns 1 when no query and not interactive."""
        with patch("cocoindex.init"):
            args = argparse.Namespace(
                query=None,
                index="testindex",
                limit=10,
                lang=None,
                min_score=0.3,
                context=5,
                pretty=False,
                interactive=False,
            )
            result = search_command(args)
        assert result == 1
        captured = capsys.readouterr()
        assert "Query required" in captured.out

    def test_json_output_is_valid(self, capsys, mock_code_to_embedding, mock_db_pool):
        """Search returns parseable JSON."""
        pool, cursor = mock_db_pool(results=[
            ("/test/file.py", 0, 100, 0.9),
        ])

        with patch("cocoindex.init"):
            with patch("cocosearch.search.db.get_connection_pool", return_value=pool):
                with patch("cocosearch.search.utils.byte_to_line", return_value=1):
                    with patch("cocosearch.search.utils.read_chunk_content", return_value="code"):
                        args = argparse.Namespace(
                            query="test query",
                            index="testindex",
                            limit=10,
                            lang=None,
                            min_score=0.3,
                            context=5,
                            pretty=False,
                            interactive=False,
                        )
                        result = search_command(args)

        assert result == 0
        captured = capsys.readouterr()
        output = json.loads(captured.out)
        assert isinstance(output, list)


class TestListCommand:
    """Tests for list_command."""

    def test_json_output(self, capsys, mock_db_pool):
        """Returns JSON list of indexes."""
        pool, cursor = mock_db_pool(results=[
            ("codeindex_myproject__myproject_chunks",),
        ])

        with patch("cocoindex.init"):
            with patch("cocosearch.management.discovery.get_connection_pool", return_value=pool):
                args = argparse.Namespace(pretty=False)
                result = list_command(args)

        assert result == 0
        captured = capsys.readouterr()
        output = json.loads(captured.out)
        assert isinstance(output, list)
```
  </action>
  <verify>pytest tests/test_cli.py::TestIndexCommand tests/test_cli.py::TestSearchCommand tests/test_cli.py::TestListCommand -v --tb=short</verify>
  <done>Index, search, and list command tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Create tests for stats and clear commands, verify all CLI tests</name>
  <files>
    tests/test_cli.py
  </files>
  <action>
Append to tests/test_cli.py:

```python
class TestStatsCommand:
    """Tests for stats_command."""

    def test_specific_index_json(self, capsys, mock_db_pool):
        """Returns stats for specific index."""
        pool, cursor = mock_db_pool(results=[
            (True,),  # EXISTS check
            (10, 50),  # COUNT query (file_count, chunk_count)
            (1024 * 1024,),  # pg_table_size
        ])

        with patch("cocoindex.init"):
            with patch("cocosearch.management.stats.get_connection_pool", return_value=pool):
                args = argparse.Namespace(index="testindex", pretty=False)
                result = stats_command(args)

        assert result == 0
        captured = capsys.readouterr()
        output = json.loads(captured.out)
        assert "file_count" in output

    def test_nonexistent_index_error(self, capsys, mock_db_pool):
        """Returns error for nonexistent index."""
        pool, cursor = mock_db_pool(results=[(False,)])  # EXISTS returns False

        with patch("cocoindex.init"):
            with patch("cocosearch.management.stats.get_connection_pool", return_value=pool):
                args = argparse.Namespace(index="missing", pretty=False)
                result = stats_command(args)

        assert result == 1


class TestClearCommand:
    """Tests for clear_command."""

    def test_force_deletes_without_prompt(self, capsys, mock_db_pool):
        """--force skips confirmation."""
        pool, cursor = mock_db_pool(results=[
            (True,),  # EXISTS for get_stats
            (5, 25),  # COUNT for get_stats
            (512,),   # pg_table_size for get_stats
            (True,),  # EXISTS for clear_index
        ])

        with patch("cocoindex.init"):
            with patch("cocosearch.management.stats.get_connection_pool", return_value=pool):
                with patch("cocosearch.management.clear.get_connection_pool", return_value=pool):
                    args = argparse.Namespace(index="testindex", force=True, pretty=False)
                    result = clear_command(args)

        assert result == 0
        captured = capsys.readouterr()
        output = json.loads(captured.out)
        assert output["success"] is True

    def test_nonexistent_index_error(self, capsys, mock_db_pool):
        """Returns error for nonexistent index."""
        pool, cursor = mock_db_pool(results=[(False,)])

        with patch("cocoindex.init"):
            with patch("cocosearch.management.stats.get_connection_pool", return_value=pool):
                args = argparse.Namespace(index="missing", force=True, pretty=False)
                result = clear_command(args)

        assert result == 1


class TestErrorHandling:
    """Tests for CLI error handling."""

    def test_search_error_returns_json_error(self, capsys):
        """Search errors return JSON error object."""
        with patch("cocoindex.init"):
            with patch("cocosearch.cli.search", side_effect=ValueError("DB error")):
                args = argparse.Namespace(
                    query="test",
                    index="testindex",
                    limit=10,
                    lang=None,
                    min_score=0.3,
                    context=5,
                    pretty=False,
                    interactive=False,
                )
                result = search_command(args)

        assert result == 1
        captured = capsys.readouterr()
        output = json.loads(captured.out)
        assert "error" in output
```

Run all CLI tests:
```bash
pytest tests/test_cli.py -v --tb=short
```

Expected: ~15-20 tests passing.
  </action>
  <verify>pytest tests/test_cli.py -v --tb=short && echo "All CLI tests passed"</verify>
  <done>All CLI tests pass (TEST-CLI-01 through TEST-CLI-03 complete)</done>
</task>

</tasks>

<verification>
```bash
# Run all CLI tests
pytest tests/test_cli.py -v --tb=short

# Verify no real services called
COCOINDEX_DATABASE_URL="" pytest tests/test_cli.py -v
```
</verification>

<success_criteria>
- tests/test_cli.py exists with ~150+ lines
- All tests pass with mocked dependencies
- Tests cover: index, search, list, stats, clear commands
- Tests cover: JSON and pretty output modes
- Tests cover: error handling and exit codes
- No real database or Ollama connections during tests
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-coverage/06-04-SUMMARY.md`
</output>
