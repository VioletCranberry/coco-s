---
phase: 06-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/indexer/__init__.py
  - tests/indexer/test_config.py
  - tests/indexer/test_file_filter.py
  - tests/indexer/test_embedder.py
  - tests/indexer/test_progress.py
  - tests/indexer/test_flow.py
autonomous: true

must_haves:
  truths:
    - "pytest runs indexer tests without real Ollama or database"
    - "Config loading handles valid YAML, invalid YAML, and missing files"
    - "File filter builds patterns from defaults, gitignore, and user excludes"
    - "Progress display captures Rich output without crashing"
  artifacts:
    - path: "tests/indexer/test_config.py"
      provides: "Config loading tests"
      min_lines: 40
    - path: "tests/indexer/test_file_filter.py"
      provides: "File pattern tests"
      min_lines: 50
    - path: "tests/indexer/test_embedder.py"
      provides: "Embedding function tests"
      min_lines: 30
    - path: "tests/indexer/test_progress.py"
      provides: "Progress display tests"
      min_lines: 40
    - path: "tests/indexer/test_flow.py"
      provides: "Indexing flow tests"
      min_lines: 30
  key_links:
    - from: "tests/indexer/test_embedder.py"
      to: "tests/fixtures/ollama.py"
      via: "mock_code_to_embedding fixture"
      pattern: "mock_code_to_embedding"
    - from: "tests/indexer/test_progress.py"
      to: "io.StringIO"
      via: "Rich Console capture"
      pattern: "Console\\(file=.*StringIO"
---

<objective>
Create comprehensive tests for the indexer module covering configuration, file filtering, embedding, progress display, and indexing flow.

Purpose: Fulfill TEST-IDX-01 through TEST-IDX-05 requirements with tests that use mocked dependencies (no real Ollama/DB).
Output: Test files in tests/indexer/ that pass with `pytest tests/indexer/`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-coverage/06-CONTEXT.md
@.planning/phases/06-test-coverage/06-RESEARCH.md
@.planning/phases/05-test-infrastructure/05-03-SUMMARY.md

# Source files to test
@src/cocosearch/indexer/config.py
@src/cocosearch/indexer/file_filter.py
@src/cocosearch/indexer/embedder.py
@src/cocosearch/indexer/progress.py
@src/cocosearch/indexer/flow.py

# Existing fixtures
@tests/conftest.py
@tests/fixtures/ollama.py
@tests/fixtures/data.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create indexer test directory and config/file_filter tests</name>
  <files>
    tests/indexer/__init__.py
    tests/indexer/test_config.py
    tests/indexer/test_file_filter.py
  </files>
  <action>
Create tests/indexer/__init__.py as empty package marker.

Create tests/indexer/test_config.py testing:
- TestIndexingConfig: defaults (include_patterns contains *.py, chunk_size=1000)
- TestLoadConfig:
  - test_returns_defaults_when_no_config: No .cocosearch.yaml returns defaults
  - test_loads_from_yaml: Valid YAML file overrides defaults
  - test_returns_defaults_on_malformed_yaml: Invalid YAML returns defaults
  - test_merges_partial_config: Partial YAML merges with defaults

Use tmp_path fixture for all file operations.

Create tests/indexer/test_file_filter.py testing:
- TestDefaultExcludes: Verify DEFAULT_EXCLUDES contains expected patterns (node_modules, __pycache__, .git)
- TestLoadGitignorePatterns:
  - test_returns_empty_when_no_gitignore: Missing .gitignore returns []
  - test_loads_patterns_from_file: Reads non-empty, non-comment lines
  - test_ignores_comments_and_empty: Filters out # comments and blank lines
- TestBuildExcludePatterns:
  - test_includes_defaults: Always includes DEFAULT_EXCLUDES
  - test_adds_gitignore_when_enabled: Includes .gitignore patterns when respect_gitignore=True
  - test_skips_gitignore_when_disabled: Excludes .gitignore when respect_gitignore=False
  - test_adds_user_excludes: Appends user-provided patterns
  </action>
  <verify>pytest tests/indexer/test_config.py tests/indexer/test_file_filter.py -v --tb=short</verify>
  <done>All config and file_filter tests pass, covering happy paths and edge cases</done>
</task>

<task type="auto">
  <name>Task 2: Create embedder and progress tests</name>
  <files>
    tests/indexer/test_embedder.py
    tests/indexer/test_progress.py
  </files>
  <action>
Create tests/indexer/test_embedder.py testing:
- TestCodeToEmbedding:
  - test_generates_embedding_vector: Returns list of floats
  - test_embedding_has_correct_dimensions: Returns 768-dim vector (nomic-embed-text default)
  - test_different_inputs_different_embeddings: Different code produces different vectors

Use mock_code_to_embedding fixture to avoid real Ollama calls. The fixture patches code_to_embedding.eval() to return deterministic embeddings.

Create tests/indexer/test_progress.py testing:
- TestIndexingProgress:
  - test_context_manager_works: Can use as `with IndexingProgress() as progress`
  - test_start_indexing_displays: start_indexing(path) shows progress indicator
  - test_complete_displays_stats: complete(stats_dict) shows summary

For Rich output capture, use Console(file=io.StringIO(), force_terminal=True, width=80). This captures output without terminal detection issues. Don't assert on exact formatting - just verify key content is present.
  </action>
  <verify>pytest tests/indexer/test_embedder.py tests/indexer/test_progress.py -v --tb=short</verify>
  <done>Embedder and progress tests pass with mocked dependencies</done>
</task>

<task type="auto">
  <name>Task 3: Create flow tests and verify all indexer tests</name>
  <files>
    tests/indexer/test_flow.py
  </files>
  <action>
Create tests/indexer/test_flow.py testing:
- TestRunIndex:
  - test_returns_update_info: run_index returns object with stats attribute
  - test_respects_config: Passes config to flow correctly

For flow tests, mock cocoindex.init() and the flow execution. The run_index function internally creates a CocoIndex flow, so mock at that boundary:
- patch("cocosearch.indexer.flow.cocoindex.Flow") to return mock flow
- patch("cocoindex.init") to avoid DB connection

Test the integration through run_index() rather than testing flow decorators directly.

Verify all indexer tests run together:
pytest tests/indexer/ -v --tb=short

Expected: ~15-20 tests passing across 5 test files.
  </action>
  <verify>pytest tests/indexer/ -v --tb=short && echo "All indexer tests passed"</verify>
  <done>All indexer module tests pass (TEST-IDX-01 through TEST-IDX-05 complete)</done>
</task>

</tasks>

<verification>
```bash
# Run all indexer tests
pytest tests/indexer/ -v --tb=short

# Verify no real services called (should pass without Ollama/DB running)
COCOINDEX_DATABASE_URL="" pytest tests/indexer/ -v
```
</verification>

<success_criteria>
- tests/indexer/ directory exists with 5 test files
- All tests pass with mocked dependencies
- Tests cover: config loading, file filtering, embedding, progress display, indexing flow
- No real Ollama or PostgreSQL connections made during tests
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-coverage/06-01-SUMMARY.md`
</output>
