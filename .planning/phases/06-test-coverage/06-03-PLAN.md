---
phase: 06-test-coverage
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/management/__init__.py
  - tests/management/test_git.py
  - tests/management/test_discovery.py
  - tests/management/test_clear.py
  - tests/management/test_stats.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "pytest runs management tests without real git or database"
    - "Git root detection returns Path in repo, None outside repo"
    - "list_indexes returns list of index dicts from database"
    - "clear_index deletes table and returns success dict"
    - "get_stats returns file count, chunk count, storage size"
  artifacts:
    - path: "tests/management/test_git.py"
      provides: "Git integration tests"
      min_lines: 40
    - path: "tests/management/test_discovery.py"
      provides: "Index discovery tests"
      min_lines: 30
    - path: "tests/management/test_clear.py"
      provides: "Index clearing tests"
      min_lines: 40
    - path: "tests/management/test_stats.py"
      provides: "Statistics tests"
      min_lines: 50
  key_links:
    - from: "tests/management/test_git.py"
      to: "pytest-subprocess"
      via: "fp fixture for subprocess mocking"
      pattern: "fp\\.register"
    - from: "tests/management/test_stats.py"
      to: "tests/fixtures/db.py"
      via: "mock_db_pool fixture"
      pattern: "mock_db_pool"
---

<objective>
Create comprehensive tests for the management module covering git integration, index discovery, clearing, and statistics.

Purpose: Fulfill TEST-MGT-01 through TEST-MGT-04 requirements. Install pytest-subprocess for git command mocking.
Output: Test files in tests/management/ that pass with `pytest tests/management/`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-coverage/06-CONTEXT.md
@.planning/phases/06-test-coverage/06-RESEARCH.md
@.planning/phases/05-test-infrastructure/05-02-SUMMARY.md

# Source files to test
@src/cocosearch/management/git.py
@src/cocosearch/management/discovery.py
@src/cocosearch/management/clear.py
@src/cocosearch/management/stats.py

# Existing fixtures
@tests/conftest.py
@tests/fixtures/db.py
@tests/mocks/db.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install pytest-subprocess and create git tests</name>
  <files>
    pyproject.toml
    tests/management/__init__.py
    tests/management/test_git.py
  </files>
  <action>
Add pytest-subprocess to dev dependencies in pyproject.toml:
```toml
[dependency-groups]
dev = [
    "pytest>=9.0.2",
    "pytest-asyncio>=1.3.0",
    "pytest-httpx>=0.36.0",
    "pytest-mock>=3.15.1",
    "pytest-subprocess>=1.5.3",
    "ruff>=0.14.14",
]
```

Run: uv sync

Create tests/management/__init__.py as empty package marker.

Create tests/management/test_git.py testing:
- TestGetGitRoot:
  - test_returns_path_in_git_repo: Returns Path when git rev-parse succeeds
  - test_returns_none_outside_repo: Returns None when git rev-parse fails (returncode=128)
- TestDeriveIndexFromGit:
  - test_returns_index_name_in_repo: Returns sanitized directory name
  - test_returns_none_outside_repo: Returns None when not in git repo

Use pytest-subprocess's `fp` fixture to mock git commands:
```python
def test_returns_path_in_git_repo(fp):
    fp.register(
        ["git", "rev-parse", "--show-toplevel"],
        stdout="/home/user/myproject\n"
    )
    result = get_git_root()
    assert result == Path("/home/user/myproject")

def test_returns_none_outside_repo(fp):
    fp.register(
        ["git", "rev-parse", "--show-toplevel"],
        returncode=128,
        stderr="fatal: not a git repository"
    )
    result = get_git_root()
    assert result is None
```
  </action>
  <verify>uv sync && pytest tests/management/test_git.py -v --tb=short</verify>
  <done>pytest-subprocess installed and git tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Create discovery and clear tests</name>
  <files>
    tests/management/test_discovery.py
    tests/management/test_clear.py
  </files>
  <action>
Create tests/management/test_discovery.py testing:
- TestListIndexes:
  - test_returns_empty_when_no_indexes: Returns [] when no tables match pattern
  - test_returns_index_list: Returns list of dicts with name and table_name
  - test_parses_table_name_correctly: Extracts name from "codeindex_X__X_chunks" pattern

Use mock_db_pool fixture:
```python
def test_returns_index_list(mock_db_pool):
    pool, cursor = mock_db_pool(results=[
        ("codeindex_myproject__myproject_chunks",),
        ("codeindex_other__other_chunks",),
    ])
    with patch("cocosearch.management.discovery.get_connection_pool", return_value=pool):
        indexes = list_indexes()
    assert len(indexes) == 2
    assert indexes[0]["name"] == "myproject"
    assert indexes[0]["table_name"] == "codeindex_myproject__myproject_chunks"
```

Create tests/management/test_clear.py testing:
- TestClearIndex:
  - test_deletes_existing_index: Returns success=True for existing index
  - test_raises_for_nonexistent: Raises ValueError for missing index
  - test_commits_transaction: Verifies commit is called after DROP

The clear_index function makes two queries: EXISTS check, then DROP TABLE.
Mock with multiple result sets or check cursor.calls for executed queries.
  </action>
  <verify>pytest tests/management/test_discovery.py tests/management/test_clear.py -v --tb=short</verify>
  <done>Discovery and clear tests pass with mocked database</done>
</task>

<task type="auto">
  <name>Task 3: Create stats tests and verify all management tests</name>
  <files>
    tests/management/test_stats.py
  </files>
  <action>
Create tests/management/test_stats.py testing:
- TestFormatBytes:
  - test_formats_bytes: Small values show "X B"
  - test_formats_kilobytes: 1024-1MB shows "X.X KB"
  - test_formats_megabytes: 1MB-1GB shows "X.X MB"
  - test_formats_gigabytes: 1GB+ shows "X.X GB"
- TestGetStats:
  - test_returns_stats_dict: Returns dict with name, file_count, chunk_count, storage_size
  - test_raises_for_nonexistent: Raises ValueError when index doesn't exist
  - test_includes_pretty_size: Returns storage_size_pretty formatted string

For get_stats, the function makes three queries: EXISTS, COUNT, pg_table_size.
Set up mock cursor to return appropriate results for each query in sequence.

Verify all management tests:
```bash
pytest tests/management/ -v --tb=short
```

Expected: ~15-18 tests passing across 4 test files.
  </action>
  <verify>pytest tests/management/ -v --tb=short && echo "All management tests passed"</verify>
  <done>All management module tests pass (TEST-MGT-01 through TEST-MGT-04 complete)</done>
</task>

</tasks>

<verification>
```bash
# Run all management tests
pytest tests/management/ -v --tb=short

# Verify subprocess mocking works
pytest tests/management/test_git.py -v
```
</verification>

<success_criteria>
- pytest-subprocess installed as dev dependency
- tests/management/ directory exists with 4 test files
- All tests pass with mocked dependencies
- Tests cover: git detection, index listing, index clearing, statistics
- No real git commands or database connections during tests
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-coverage/06-03-SUMMARY.md`
</output>
