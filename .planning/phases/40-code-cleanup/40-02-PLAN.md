---
phase: 40-code-cleanup
plan: 02
type: execute
wave: 2
depends_on: ["40-01"]
files_modified:
  - src/cocosearch/search/query.py
  - src/cocosearch/search/hybrid.py
  - src/cocosearch/search/db.py
  - src/cocosearch/management/stats.py
autonomous: true

must_haves:
  truths:
    - "Pre-v1.2 graceful degradation code removed from search modules"
    - "Metadata columns (block_type, hierarchy, language_id) always expected in queries"
    - "Search fails fast with clear error for pre-v1.2 indexes instead of silent degradation"
    - "All tests pass after removal"
  artifacts:
    - path: "src/cocosearch/search/query.py"
      provides: "Search without metadata column fallback"
      contains: "block_type"
    - path: "src/cocosearch/search/hybrid.py"
      provides: "Hybrid search without pre-v1.2 fallback"
      contains: "block_type"
  key_links:
    - from: "src/cocosearch/search/query.py"
      to: "database"
      via: "SQL query"
      pattern: "SELECT.*block_type.*hierarchy.*language_id"
---

<objective>
Remove v1.2 graceful degradation code that handles indexes without metadata columns.

Purpose: Pre-v1.2 indexes (created before DevOps metadata support) are no longer supported. Users with old indexes need to re-index. Removing this code simplifies search logic and reduces ~100 LOC.

Output: Cleaner search modules that assume metadata columns exist, with clear error messages for unsupported old indexes.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-code-cleanup/40-CONTEXT.md
@.planning/phases/40-code-cleanup/40-RESEARCH.md
@.planning/phases/40-code-cleanup/40-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove pre-v1.2 graceful degradation from query.py</name>
  <files>
    src/cocosearch/search/query.py
  </files>
  <action>
**Remove module-level flags (lines 113-119):**
Delete these lines:
```python
# Module-level flag for metadata column availability (pre-v1.2 graceful degradation)
_has_metadata_columns = True
_metadata_warning_emitted = False

# Module-level flag for hybrid search column availability (pre-v1.7 graceful degradation)
_has_content_text_column = True
_hybrid_warning_emitted = False
```

**Simplify search() function:**

1. Remove global statements at start of search():
```python
global _has_metadata_columns, _metadata_warning_emitted
global _has_content_text_column, _hybrid_warning_emitted
```

2. Remove the metadata column availability check (lines 242-246):
```python
# Check if any DevOps languages require metadata columns
devops_langs = [l for l in validated_languages if l in DEVOPS_LANGUAGES]
if devops_langs and not _has_metadata_columns:
    raise ValueError(...)
```
This check is no longer needed since metadata columns are always expected.

3. Keep the hybrid search column check but simplify - it's v1.7 feature detection, not v1.2 compat:
Keep `check_column_exists(table_name, "content_text")` but remove the module-level caching.

4. **Remove the entire try/except fallback block (lines 402-472):**
The current code tries with metadata, catches UndefinedColumn, then retries without.
Replace with simple execution that assumes columns exist:
```python
with pool.connection() as conn:
    with conn.cursor() as cur:
        cur.execute(sql, params)
        rows = cur.fetchall()
```

5. **Simplify result building (lines 474-504):**
Remove the `if include_metadata:` branch since metadata is always included.
Always build SearchResult with block_type, hierarchy, language_id.

**Keep v1.7 graceful degradation for content_text column:**
This is different from v1.2 - it's about hybrid search being available or not.
Keep the check_column_exists for content_text but remove module-level caching.
  </action>
  <verify>
Run: `uv run pytest tests/unit/search/ -v`
All search tests pass.
  </verify>
  <done>
query.py no longer has pre-v1.2 fallback code, metadata columns always expected.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove pre-v1.2 graceful degradation from hybrid.py</name>
  <files>
    src/cocosearch/search/hybrid.py
  </files>
  <action>
**In execute_vector_search() function (around line 298-322):**

Remove the try/except fallback that handles missing metadata columns:
```python
except Exception as e:
    # Graceful degradation for pre-v1.2 indexes without metadata
    logger.debug(f"Falling back to query without metadata: {e}")
    sql_fallback = ...
```

Replace with direct execution:
```python
with pool.connection() as conn:
    with conn.cursor() as cur:
        cur.execute(sql, params)
        rows = cur.fetchall()
```

**In execute_keyword_search() function (around line 214):**

The current code catches any exception and returns empty (line 214):
```python
except Exception as e:
    # Log and return empty on any error (graceful degradation)
    logger.warning(f"Keyword search failed: {e}")
    return []
```

This is acceptable behavior for keyword search (hybrid enhancement, not core). Keep as-is.
  </action>
  <verify>
Run: `uv run pytest tests/unit/search/test_hybrid.py -v`
Hybrid search tests pass.
  </verify>
  <done>
hybrid.py vector search no longer has pre-v1.2 fallback code.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update stats.py and db.py, run full verification</name>
  <files>
    src/cocosearch/management/stats.py
    src/cocosearch/search/db.py
  </files>
  <action>
**stats.py:**

The graceful degradation in stats.py (lines 155, 312) is for v1.7 features (content_text for line counts, symbol_type for symbol stats), NOT for v1.2 metadata columns.

Review and update comments for clarity:
- Line 155: "Graceful degradation for pre-v1.7 indexes" - This is about content_text column for line counting. Keep this logic but update comment to be clearer: "Pre-v1.7 indexes lack content_text column for line counting".
- Line 312: "Graceful degradation for pre-v1.7 indexes" - This is about symbol_type column. Keep this logic.

No functional changes needed in stats.py - the graceful degradation there is for v1.7, not v1.2.

**db.py:**

Review check_column_exists() function. This is a general utility used for v1.7 feature detection (content_text, symbol columns). Keep it.

Update the docstring to remove v1.2 reference:
```python
def check_column_exists(table_name: str, column_name: str) -> bool:
    """Check if a column exists in a table.

    Used for feature detection (e.g., hybrid search requires content_text column).

    Args:
        ...
```

Remove the specific v1.7 reference in line 74 comment: "For example, pre-v1.7 indexes lack content_text column for hybrid search."

**Full verification:**

```bash
uv run pytest
uv run ruff check src/
uv run mypy src/ --ignore-missing-imports
```

**Record LOC reduction:**
```bash
find src -name "*.py" | xargs wc -l | tail -1
```

**Commit:**
```bash
git add -A
git commit -m "refactor(40-02): remove pre-v1.2 graceful degradation code

- Remove metadata column fallback from search/query.py
- Remove metadata column fallback from search/hybrid.py
- Update db.py docstrings (keep utility functions for v1.7 feature detection)
- Keep v1.7 graceful degradation in stats.py (content_text, symbol_type)

Pre-v1.2 indexes (without metadata columns) are no longer supported.
Users with old indexes should re-index with 'cocosearch index'.

Resolves: CLEAN-03 (remove v1.2 graceful degradation)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```
  </action>
  <verify>
`uv run pytest` all tests pass.
`uv run ruff check src/` no errors.
Git commit created.
  </verify>
  <done>
V1.2 graceful degradation removed, v1.7 feature detection preserved, all tests pass.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `grep -r "_has_metadata_columns" src/` returns no results
2. `grep -r "pre-v1.2" src/` returns no results (or only documentation)
3. `grep -r "UndefinedColumn" src/cocosearch/search/query.py` returns no results
4. `uv run pytest` all green
5. `uv run ruff check src/` no errors
</verification>

<success_criteria>
- Module-level _has_metadata_columns flag removed from query.py
- try/except UndefinedColumn fallback removed from query.py
- Metadata fallback removed from hybrid.py execute_vector_search
- db.py docstrings updated (utility functions preserved)
- stats.py v1.7 graceful degradation preserved (content_text, symbol_type)
- All tests pass
- Git commit created
</success_criteria>

<output>
After completion, create `.planning/phases/40-code-cleanup/40-02-SUMMARY.md`
</output>
