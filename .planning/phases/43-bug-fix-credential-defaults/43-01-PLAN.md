---
phase: 43-bug-fix-credential-defaults
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cocosearch/indexer/flow.py
  - src/cocosearch/config/env_validation.py
  - src/cocosearch/config/__init__.py
  - src/cocosearch/search/db.py
  - src/cocosearch/cli.py
  - tests/unit/search/test_db.py
  - tests/unit/config/test_env_validation.py
autonomous: true

must_haves:
  truths:
    - "DevOps files (Terraform, Dockerfile, Bash) index without errors when language_id metadata is present"
    - "Running cocosearch index without COCOSEARCH_DATABASE_URL connects to the default postgresql://cocosearch:cocosearch@localhost:5432/cocosearch"
    - "cocosearch config check shows 'default' source for DATABASE_URL when no env var is set"
    - "CocoIndex SDK receives COCOINDEX_DATABASE_URL via environment bridge when only COCOSEARCH_DATABASE_URL default is used"
  artifacts:
    - path: "src/cocosearch/config/env_validation.py"
      provides: "DEFAULT_DATABASE_URL constant and get_database_url() helper"
      exports: ["DEFAULT_DATABASE_URL", "get_database_url"]
      contains: "def get_database_url"
    - path: "src/cocosearch/indexer/flow.py"
      provides: "Fixed extract_devops_metadata call with language_id keyword"
      contains: "language_id=file"
    - path: "src/cocosearch/search/db.py"
      provides: "Connection pool using get_database_url() instead of raw os.getenv"
      contains: "get_database_url"
    - path: "src/cocosearch/cli.py"
      provides: "Early get_database_url() call in main() and config check showing default source"
      contains: "get_database_url"
    - path: "tests/unit/config/test_env_validation.py"
      provides: "Tests for get_database_url() including default, env override, and CocoIndex bridge"
  key_links:
    - from: "src/cocosearch/config/env_validation.py"
      to: "os.environ['COCOINDEX_DATABASE_URL']"
      via: "get_database_url() side effect"
      pattern: "os\\.environ\\[.COCOINDEX_DATABASE_URL.\\]"
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/config/env_validation.py"
      via: "import and call get_database_url() in main()"
      pattern: "from cocosearch\\.config.*import.*get_database_url"
    - from: "src/cocosearch/search/db.py"
      to: "src/cocosearch/config/env_validation.py"
      via: "import get_database_url for connection pool"
      pattern: "from cocosearch\\.config.*import.*get_database_url"
---

<objective>
Fix the DevOps metadata keyword bug and establish default database credentials across all Python source code.

Purpose: Enable zero-config startup -- users can run `docker compose up && cocosearch index .` without setting any environment variables. Also fixes a bug that prevents DevOps file indexing.

Output: Working `get_database_url()` helper used by all callsites, fixed `language_id` keyword, updated config check display, and passing tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-bug-fix-credential-defaults/43-RESEARCH.md
@src/cocosearch/config/env_validation.py
@src/cocosearch/config/__init__.py
@src/cocosearch/indexer/flow.py
@src/cocosearch/search/db.py
@src/cocosearch/cli.py
@tests/unit/search/test_db.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix bug and create get_database_url() with CocoIndex bridge</name>
  <files>
    src/cocosearch/indexer/flow.py
    src/cocosearch/config/env_validation.py
    src/cocosearch/config/__init__.py
    src/cocosearch/search/db.py
  </files>
  <action>
    **FIX-01: Fix keyword argument bug (flow.py:93)**

    Change line 93 from:
    ```python
    language=file["extension"],
    ```
    to:
    ```python
    language_id=file["extension"],
    ```

    IMPORTANT: Do NOT change line 80 (`language=file["extension"]` in `SplitRecursively`) or line 99 (`language=file["extension"]` in `extract_symbol_metadata`). Only line 93 (`extract_devops_metadata` call) has the wrong keyword. The other two functions use `language` correctly.

    **INFRA-01: Create centralized get_database_url() in env_validation.py**

    Add at the top of env_validation.py (after imports):
    ```python
    DEFAULT_DATABASE_URL = "postgresql://cocosearch:cocosearch@localhost:5432/cocosearch"
    ```

    Add new function:
    ```python
    def get_database_url() -> str:
        """Get database URL from environment or return default.

        Returns COCOSEARCH_DATABASE_URL if set, otherwise the default
        (postgresql://cocosearch:cocosearch@localhost:5432/cocosearch).

        Side effect: Sets COCOINDEX_DATABASE_URL in os.environ if not already
        set, bridging to the CocoIndex SDK which reads that variable.
        """
        url = os.getenv("COCOSEARCH_DATABASE_URL", DEFAULT_DATABASE_URL)
        # Bridge: CocoIndex SDK reads COCOINDEX_DATABASE_URL, not COCOSEARCH_*
        if not os.getenv("COCOINDEX_DATABASE_URL"):
            os.environ["COCOINDEX_DATABASE_URL"] = url
        return url
    ```

    **Update validate_required_env_vars()**: Remove the COCOSEARCH_DATABASE_URL check entirely. The function body should just return an empty list (no required env vars remain since DATABASE_URL now has a default). Keep the function signature and docstring for backwards compatibility.

    **Update check_env_or_exit()**: No change needed (it calls validate_required_env_vars which will now return empty).

    **Update config/__init__.py**: Add `DEFAULT_DATABASE_URL` and `get_database_url` to both the import and `__all__` list.

    **Update search/db.py get_connection_pool()**:
    - Add import: `from cocosearch.config.env_validation import get_database_url`
    - Replace lines 36-38:
      ```python
      conninfo = os.getenv("COCOSEARCH_DATABASE_URL")
      if not conninfo:
          raise ValueError("Missing COCOSEARCH_DATABASE_URL. See .env.example for format.")
      ```
      with:
      ```python
      conninfo = get_database_url()
      ```
    - Remove `import os` if no other os usage remains in the file (check first -- it is used nowhere else in db.py).

    **Update indexer/flow.py run_indexing() (around line 199-201)**:
    - Add import: `from cocosearch.config.env_validation import get_database_url`
    - Replace:
      ```python
      db_url = os.getenv("COCOSEARCH_DATABASE_URL")
      if not db_url:
          raise ValueError("Missing COCOSEARCH_DATABASE_URL environment variable")
      ```
      with:
      ```python
      db_url = get_database_url()
      ```
    - Keep `import os` since flow.py uses os elsewhere.
  </action>
  <verify>
    Run: `cd /Users/fzhdanov/GIT/personal/coco-s && python -c "from cocosearch.config.env_validation import get_database_url, DEFAULT_DATABASE_URL; print(DEFAULT_DATABASE_URL); print(get_database_url())"`
    Expected: Prints the default URL twice.

    Run: `cd /Users/fzhdanov/GIT/personal/coco-s && grep -n 'language_id=file' src/cocosearch/indexer/flow.py`
    Expected: Shows the fixed line 93 with `language_id=file["extension"]`.

    Run: `cd /Users/fzhdanov/GIT/personal/coco-s && python -c "from cocosearch.config import get_database_url, DEFAULT_DATABASE_URL; print('imports ok')"`
    Expected: Prints "imports ok".
  </verify>
  <done>
    - flow.py:93 uses `language_id=` keyword (FIX-01 complete)
    - `get_database_url()` exists and returns default when no env var set
    - `get_database_url()` sets COCOINDEX_DATABASE_URL in os.environ as bridge
    - `search/db.py` uses `get_database_url()` instead of raw os.getenv
    - `indexer/flow.py` run_indexing uses `get_database_url()` instead of raw os.getenv
    - `validate_required_env_vars()` no longer errors on missing DATABASE_URL
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI config check and main() bridge, update tests</name>
  <files>
    src/cocosearch/cli.py
    tests/unit/search/test_db.py
    tests/unit/config/test_env_validation.py
  </files>
  <action>
    **INFRA-03: Update config_check_command() in cli.py (around line 956)**

    Add import near the existing config imports (line 956 area):
    ```python
    from cocosearch.config import mask_password, validate_required_env_vars, get_database_url, DEFAULT_DATABASE_URL
    ```

    Replace the DATABASE_URL display block (lines 979-985):
    ```python
    # DATABASE_URL (required)
    db_url = os.getenv("COCOSEARCH_DATABASE_URL")
    table.add_row(
        "COCOSEARCH_DATABASE_URL",
        mask_password(db_url),
        "environment"
    )
    ```
    with:
    ```python
    # DATABASE_URL (has default)
    db_url_env = os.getenv("COCOSEARCH_DATABASE_URL")
    if db_url_env:
        table.add_row("COCOSEARCH_DATABASE_URL", mask_password(db_url_env), "environment")
    else:
        table.add_row("COCOSEARCH_DATABASE_URL", mask_password(DEFAULT_DATABASE_URL), "default")
    ```

    **Add early get_database_url() call in main()**

    In the `main()` function (line 1036), add a call to `get_database_url()` right after parsing args (after line 1373 `args = parser.parse_args()`) and before the command dispatch. This ensures the CocoIndex environment bridge is set before any command handler calls `cocoindex.init()`:

    ```python
    args = parser.parse_args()

    # Ensure database URL default and CocoIndex bridge are set early
    from cocosearch.config.env_validation import get_database_url
    get_database_url()
    ```

    Place this BEFORE the `if args.command == "index":` dispatch block.

    **Update test_db.py**: The test `test_raises_without_env_var` (line 19-29) currently expects `ValueError` when `COCOSEARCH_DATABASE_URL` is not set. Since `get_connection_pool()` now uses `get_database_url()` which returns a default, this test needs to change.

    Replace the test with:
    ```python
    def test_uses_default_when_env_var_not_set(self):
        """Should use default DATABASE_URL when COCOSEARCH_DATABASE_URL not set."""
        db_module._pool = None

        with patch.dict(os.environ, {}, clear=True):
            with patch("cocosearch.search.db.ConnectionPool") as mock_pool_cls:
                mock_pool_cls.return_value = MagicMock()
                pool = get_connection_pool()

        # Verify ConnectionPool was called with the default URL
        mock_pool_cls.assert_called_once()
        call_kwargs = mock_pool_cls.call_args
        assert "cocosearch:cocosearch" in call_kwargs.kwargs.get("conninfo", call_kwargs.args[0] if call_kwargs.args else "")
    ```

    Also add the necessary import at the top of the test file if not present: `from unittest.mock import patch, MagicMock` (already there).

    **Create test_env_validation.py**: Create a new test file `tests/unit/config/test_env_validation.py` with tests for `get_database_url()`:

    ```python
    """Tests for cocosearch.config.env_validation module."""

    import os
    from unittest.mock import patch

    from cocosearch.config.env_validation import (
        DEFAULT_DATABASE_URL,
        get_database_url,
        validate_required_env_vars,
    )


    class TestGetDatabaseUrl:
        """Tests for get_database_url function."""

        def test_returns_default_when_no_env_var(self):
            """Should return default URL when COCOSEARCH_DATABASE_URL not set."""
            with patch.dict(os.environ, {}, clear=True):
                result = get_database_url()
            assert result == DEFAULT_DATABASE_URL
            assert "cocosearch:cocosearch" in result

        def test_returns_env_var_when_set(self):
            """Should return env var value when COCOSEARCH_DATABASE_URL is set."""
            custom_url = "postgresql://custom:pass@host:5432/mydb"
            with patch.dict(os.environ, {"COCOSEARCH_DATABASE_URL": custom_url}, clear=True):
                result = get_database_url()
            assert result == custom_url

        def test_bridges_to_cocoindex_env_var(self):
            """Should set COCOINDEX_DATABASE_URL when not already set."""
            with patch.dict(os.environ, {}, clear=True):
                url = get_database_url()
                assert os.environ.get("COCOINDEX_DATABASE_URL") == url

        def test_does_not_override_existing_cocoindex_var(self):
            """Should not override COCOINDEX_DATABASE_URL if already set."""
            existing = "postgresql://other:pass@host:5432/other"
            with patch.dict(os.environ, {"COCOINDEX_DATABASE_URL": existing}, clear=True):
                get_database_url()
                assert os.environ["COCOINDEX_DATABASE_URL"] == existing


    class TestValidateRequiredEnvVars:
        """Tests for validate_required_env_vars after default addition."""

        def test_no_errors_without_database_url(self):
            """Should return no errors when DATABASE_URL is not set (has default)."""
            with patch.dict(os.environ, {}, clear=True):
                errors = validate_required_env_vars()
            assert len(errors) == 0

        def test_no_errors_with_database_url(self):
            """Should return no errors when DATABASE_URL is set."""
            with patch.dict(os.environ, {"COCOSEARCH_DATABASE_URL": "postgresql://x:x@localhost/db"}, clear=True):
                errors = validate_required_env_vars()
            assert len(errors) == 0
    ```
  </action>
  <verify>
    Run all unit tests:
    ```
    cd /Users/fzhdanov/GIT/personal/coco-s && uv run python -m pytest tests/unit/config/test_env_validation.py tests/unit/search/test_db.py -v
    ```
    Expected: All tests pass.

    Run the full unit test suite to check for regressions:
    ```
    cd /Users/fzhdanov/GIT/personal/coco-s && uv run python -m pytest tests/unit/ -v
    ```
    Expected: All tests pass (no regressions from removing the ValueError check).
  </verify>
  <done>
    - `cocosearch config check` shows "default" source when COCOSEARCH_DATABASE_URL is not set (INFRA-03 complete)
    - `main()` calls `get_database_url()` before command dispatch to ensure CocoIndex bridge
    - test_db.py updated to test default behavior instead of ValueError
    - test_env_validation.py created with tests for get_database_url() (default, env override, bridge, no-override)
    - All unit tests pass
  </done>
</task>

</tasks>

<verification>
1. `grep -n 'language_id=file' src/cocosearch/indexer/flow.py` shows fixed keyword at line 93
2. `grep -n 'language=file' src/cocosearch/indexer/flow.py` shows unchanged lines 80 and 99 (SplitRecursively and extract_symbol_metadata)
3. `python -c "from cocosearch.config.env_validation import get_database_url, DEFAULT_DATABASE_URL; print(get_database_url())"` prints default URL without error
4. `uv run python -m pytest tests/unit/ -v` all tests pass
5. `grep -c 'get_database_url' src/cocosearch/search/db.py src/cocosearch/indexer/flow.py src/cocosearch/cli.py` shows usage in all three files
</verification>

<success_criteria>
- FIX-01: flow.py:93 uses `language_id=` keyword
- INFRA-01: `get_database_url()` returns default when no env var set, bridges to COCOINDEX_DATABASE_URL
- INFRA-03: `config check` shows "default" source for DATABASE_URL when not in environment
- All callsites (search/db.py, indexer/flow.py) use `get_database_url()` instead of raw os.getenv
- All unit tests pass with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/43-bug-fix-credential-defaults/43-01-SUMMARY.md`
</output>
