---
phase: 20-env-var-standardization
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/cocosearch/cli.py
autonomous: true

must_haves:
  truths:
    - "User can run 'cocosearch config check' and see env var validation status"
    - "Config check command shows COCOSEARCH_DATABASE_URL status"
    - "Config check command shows COCOSEARCH_OLLAMA_URL status with source (env or default)"
    - "Config check masks database password in display"
  artifacts:
    - path: "src/cocosearch/cli.py"
      provides: "config check subcommand"
      contains: "config_check_command"
  key_links:
    - from: "src/cocosearch/cli.py"
      to: "cocosearch.config.env_validation"
      via: "import and call validate_required_env_vars"
      pattern: "validate_required_env_vars"
---

<objective>
Add `cocosearch config check` CLI command for lightweight environment variable validation without connecting to services.

Purpose: Enable users to troubleshoot configuration issues and validate setup before running commands.

Output: New config check subcommand in cli.py that validates and displays env var status.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-env-var-standardization/20-CONTEXT.md
@.planning/phases/20-env-var-standardization/20-RESEARCH.md
@.planning/phases/20-env-var-standardization/20-01-SUMMARY.md
@src/cocosearch/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config check command function</name>
  <files>src/cocosearch/cli.py</files>
  <action>
Add the config_check_command function to cli.py (place it after config_path_command):

```python
def config_check_command(args: argparse.Namespace) -> int:
    """Execute the config check command.

    Validates environment variables without connecting to services.
    Lightweight check for troubleshooting and CI/CD validation.

    Args:
        args: Parsed command-line arguments.

    Returns:
        Exit code (0 for valid, 1 for errors).
    """
    from rich.table import Table

    from cocosearch.config import mask_password, validate_required_env_vars

    console = Console()

    # Validate required variables
    errors = validate_required_env_vars()

    if errors:
        console.print("[bold red]Environment configuration errors:[/bold red]")
        for error in errors:
            console.print(f"  - {error.hint}")
        console.print("\n[dim]See .env.example for configuration format.[/dim]")
        return 1

    # Show success + current values
    console.print("[green]Environment configuration is valid[/green]\n")

    # Display current environment variables
    table = Table(title="Environment Variables")
    table.add_column("Variable", style="cyan")
    table.add_column("Value", style="white")
    table.add_column("Source", style="dim")

    # DATABASE_URL (required)
    db_url = os.getenv("COCOSEARCH_DATABASE_URL")
    table.add_row(
        "COCOSEARCH_DATABASE_URL",
        mask_password(db_url),
        "environment"
    )

    # OLLAMA_URL (optional with default)
    ollama_url = os.getenv("COCOSEARCH_OLLAMA_URL")
    if ollama_url:
        table.add_row("COCOSEARCH_OLLAMA_URL", ollama_url, "environment")
    else:
        table.add_row(
            "COCOSEARCH_OLLAMA_URL",
            "http://localhost:11434",
            "default"
        )

    console.print(table)
    return 0
```

Key behaviors:
- Import validate_required_env_vars and mask_password from cocosearch.config
- Return exit code 1 if validation fails
- Show all missing variables together (not fail on first)
- Mask database password in display using mask_password()
- Show source as "environment" or "default"
  </action>
  <verify>
    grep -n "def config_check_command" src/cocosearch/cli.py
    grep -n "validate_required_env_vars" src/cocosearch/cli.py
  </verify>
  <done>
    - config_check_command function exists in cli.py
    - Function imports and uses validate_required_env_vars
    - Function uses mask_password for database URL display
  </done>
</task>

<task type="auto">
  <name>Task 2: Register config check subcommand</name>
  <files>src/cocosearch/cli.py</files>
  <action>
1. Add the config check subparser after the existing config path subparser (around line 816-820):

```python
# Config check subcommand
config_subparsers.add_parser(
    "check",
    help="Validate environment variables",
    description="Validate required environment variables without connecting to services.",
)
```

2. Add the routing case in main() after the existing config_command == "path" case (around line 853-855):

```python
elif args.config_command == "check":
    sys.exit(config_check_command(args))
```

The full config command routing should look like:
```python
elif args.command == "config":
    if args.config_command == "show":
        sys.exit(config_show_command(args))
    elif args.config_command == "path":
        sys.exit(config_path_command(args))
    elif args.config_command == "check":
        sys.exit(config_check_command(args))
    else:
        parser.print_help()
        sys.exit(1)
```
  </action>
  <verify>
    uv run cocosearch config --help
    uv run cocosearch config check --help
  </verify>
  <done>
    - 'cocosearch config check' appears in config help output
    - 'cocosearch config check --help' shows description
    - Command is properly routed in main()
  </done>
</task>

<task type="auto">
  <name>Task 3: Test config check command</name>
  <files>src/cocosearch/cli.py</files>
  <action>
No file changes - verification task only.

Test the command in various scenarios:

1. With valid DATABASE_URL set:
   ```bash
   COCOSEARCH_DATABASE_URL="postgresql://user:pass@localhost:5432/db" uv run cocosearch config check
   ```
   Expected: Exit 0, table shows both variables, password masked as ***

2. Without DATABASE_URL set:
   ```bash
   unset COCOSEARCH_DATABASE_URL && uv run cocosearch config check
   ```
   Expected: Exit 1, error message about missing COCOSEARCH_DATABASE_URL

3. With both variables set:
   ```bash
   COCOSEARCH_DATABASE_URL="postgresql://user:pass@localhost:5432/db" \
   COCOSEARCH_OLLAMA_URL="http://custom:11434" \
   uv run cocosearch config check
   ```
   Expected: Exit 0, both show "environment" as source

4. With only DATABASE_URL set (OLLAMA_URL defaults):
   ```bash
   COCOSEARCH_DATABASE_URL="postgresql://user:pass@localhost:5432/db" uv run cocosearch config check
   ```
   Expected: Exit 0, OLLAMA_URL shows "http://localhost:11434" with source "default"
  </action>
  <verify>
    # Test with valid config
    COCOSEARCH_DATABASE_URL="postgresql://user:pass@localhost:5432/db" uv run cocosearch config check && echo "Exit code: 0"

    # Test password masking
    COCOSEARCH_DATABASE_URL="postgresql://user:secret123@localhost:5432/db" uv run cocosearch config check 2>&1 | grep -q "***" && echo "Password masked: yes"
  </verify>
  <done>
    - Config check returns 0 with valid DATABASE_URL
    - Config check returns 1 when DATABASE_URL is missing
    - Password is masked in output (shows *** instead of actual password)
    - OLLAMA_URL shows correct source (environment or default)
  </done>
</task>

</tasks>

<verification>
Run all verification commands:
```bash
# 1. Command registration
uv run cocosearch config --help | grep -q "check" && echo "check command registered"

# 2. Valid config test
COCOSEARCH_DATABASE_URL="postgresql://user:pass@localhost:5432/db" uv run cocosearch config check
echo "Exit code: $?"

# 3. Missing config test
(unset COCOSEARCH_DATABASE_URL; uv run cocosearch config check; echo "Exit code: $?")

# 4. Password masking test
COCOSEARCH_DATABASE_URL="postgresql://user:secret123@localhost:5432/db" uv run cocosearch config check 2>&1 | grep "***"
```
</verification>

<success_criteria>
1. `cocosearch config check` command is available
2. Command returns exit code 0 when DATABASE_URL is set
3. Command returns exit code 1 when DATABASE_URL is missing
4. Password is masked in output
5. OLLAMA_URL shows source correctly (environment vs default)
</success_criteria>

<output>
After completion, create `.planning/phases/20-env-var-standardization/20-03-SUMMARY.md`
</output>
