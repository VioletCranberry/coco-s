---
phase: 20-env-var-standardization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cocosearch/search/db.py
  - src/cocosearch/indexer/embedder.py
  - src/cocosearch/config/env_validation.py
  - tests/unit/search/test_db.py
autonomous: true

must_haves:
  truths:
    - "Code reads COCOSEARCH_DATABASE_URL instead of COCOINDEX_DATABASE_URL"
    - "Code reads COCOSEARCH_OLLAMA_URL instead of OLLAMA_HOST"
    - "Validation function returns list of missing required env vars"
  artifacts:
    - path: "src/cocosearch/search/db.py"
      provides: "Database connection pool reading COCOSEARCH_DATABASE_URL"
      contains: "COCOSEARCH_DATABASE_URL"
    - path: "src/cocosearch/indexer/embedder.py"
      provides: "Embedder reading COCOSEARCH_OLLAMA_URL"
      contains: "COCOSEARCH_OLLAMA_URL"
    - path: "src/cocosearch/config/env_validation.py"
      provides: "Fail-fast environment variable validation"
      exports: ["validate_required_env_vars", "check_env_or_exit", "mask_password"]
  key_links:
    - from: "src/cocosearch/search/db.py"
      to: "os.getenv"
      via: "COCOSEARCH_DATABASE_URL environment variable"
      pattern: 'os\\.getenv\\("COCOSEARCH_DATABASE_URL"\\)'
    - from: "src/cocosearch/indexer/embedder.py"
      to: "os.environ.get"
      via: "COCOSEARCH_OLLAMA_URL environment variable"
      pattern: 'os\\.environ\\.get\\("COCOSEARCH_OLLAMA_URL"\\)'
---

<objective>
Migrate core application code from legacy environment variable names (COCOINDEX_DATABASE_URL, OLLAMA_HOST) to standardized COCOSEARCH_* prefix (COCOSEARCH_DATABASE_URL, COCOSEARCH_OLLAMA_URL). Add environment variable validation module.

Purpose: Establish consistent COCOSEARCH_* naming convention across the codebase, enabling cleaner configuration and better user experience.

Output: Updated db.py, embedder.py, new env_validation.py module, and updated unit tests.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-env-var-standardization/20-CONTEXT.md
@.planning/phases/20-env-var-standardization/20-RESEARCH.md
@src/cocosearch/search/db.py
@src/cocosearch/indexer/embedder.py
@tests/unit/search/test_db.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update database module env var and create validation module</name>
  <files>
    src/cocosearch/search/db.py
    src/cocosearch/config/env_validation.py
  </files>
  <action>
1. In `src/cocosearch/search/db.py`:
   - Change `COCOINDEX_DATABASE_URL` to `COCOSEARCH_DATABASE_URL` in all locations
   - Update docstrings to reference the new variable name
   - Update error message to say "Missing COCOSEARCH_DATABASE_URL. See .env.example for format."

2. Create `src/cocosearch/config/env_validation.py` with:
   - `EnvVarError` NamedTuple with fields: var_name (str), hint (str)
   - `validate_required_env_vars() -> list[EnvVarError]`: Check COCOSEARCH_DATABASE_URL is set, return list of errors (empty if all valid). COCOSEARCH_OLLAMA_URL is optional (has default), so don't validate it.
   - `check_env_or_exit(console: Console) -> None`: Call validate_required_env_vars(), if errors print them all with rich formatting and sys.exit(1). Format: "[bold red]Environment configuration errors:[/bold red]" followed by each error.hint prefixed with "  - ", then "[dim]Run 'cocosearch config check' for details.[/dim]"
   - `mask_password(url: str) -> str`: Use urllib.parse.urlparse to safely mask password in URL for display. Replace password with "***". Handle URLs without passwords gracefully (return unchanged).

3. Update `src/cocosearch/config/__init__.py` to export the new functions from env_validation.py.
  </action>
  <verify>
    python -c "from cocosearch.config import validate_required_env_vars, check_env_or_exit, mask_password; print('imports ok')"
    grep -n "COCOSEARCH_DATABASE_URL" src/cocosearch/search/db.py
  </verify>
  <done>
    - db.py reads COCOSEARCH_DATABASE_URL (no references to COCOINDEX_DATABASE_URL)
    - env_validation.py exports validate_required_env_vars, check_env_or_exit, mask_password
    - All imports work without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update embedder module env var</name>
  <files>src/cocosearch/indexer/embedder.py</files>
  <action>
In `src/cocosearch/indexer/embedder.py`:
1. Change `OLLAMA_HOST` to `COCOSEARCH_OLLAMA_URL` in all locations
2. Update docstring to say "Reads COCOSEARCH_OLLAMA_URL environment variable to determine Ollama server address."
3. Update comment to say "Read Ollama URL from environment" (was "Read Ollama address from environment")
4. Change the variable name from `ollama_host` to `ollama_url` for clarity
5. Keep the default behavior: if not set, EmbedText will use its default (localhost:11434)

The pattern should be:
```python
# Read Ollama URL from environment
# If not set, EmbedText will use its default (localhost:11434)
ollama_url = os.environ.get("COCOSEARCH_OLLAMA_URL")

return text.transform(
    cocoindex.functions.EmbedText(
        api_type=cocoindex.LlmApiType.OLLAMA,
        model="nomic-embed-text",
        address=ollama_url,
    )
)
```
  </action>
  <verify>
    grep -n "COCOSEARCH_OLLAMA_URL" src/cocosearch/indexer/embedder.py
    grep -n "OLLAMA_HOST" src/cocosearch/indexer/embedder.py || echo "No OLLAMA_HOST references - good"
  </verify>
  <done>
    - embedder.py reads COCOSEARCH_OLLAMA_URL (no references to OLLAMA_HOST)
    - Variable renamed from ollama_host to ollama_url
    - Docstring updated
  </done>
</task>

<task type="auto">
  <name>Task 3: Update unit tests</name>
  <files>tests/unit/search/test_db.py</files>
  <action>
In `tests/unit/search/test_db.py`:
1. Update docstring in test_raises_without_env_var to say "COCOSEARCH_DATABASE_URL not set"
2. Update assertion to check for "COCOSEARCH_DATABASE_URL" in error message

The test should now look like:
```python
def test_raises_without_env_var(self):
    """Should raise ValueError when COCOSEARCH_DATABASE_URL not set."""
    # Reset pool singleton to force new pool creation
    db_module._pool = None

    # Clear environment and verify error
    with patch.dict(os.environ, {}, clear=True):
        with pytest.raises(ValueError) as exc_info:
            get_connection_pool()

        assert "COCOSEARCH_DATABASE_URL" in str(exc_info.value)
        assert "not set" in str(exc_info.value)
```
  </action>
  <verify>
    uv run pytest tests/unit/search/test_db.py -v
  </verify>
  <done>
    - Unit tests pass with updated env var name
    - Test checks for COCOSEARCH_DATABASE_URL in error message
  </done>
</task>

</tasks>

<verification>
Run all verification commands:
```bash
# 1. Check imports work
python -c "from cocosearch.config import validate_required_env_vars, check_env_or_exit, mask_password"

# 2. Verify no old env var references in modified files
grep -r "COCOINDEX_DATABASE_URL" src/cocosearch/search/db.py && echo "FAIL: old var found" || echo "OK: db.py clean"
grep -r "OLLAMA_HOST" src/cocosearch/indexer/embedder.py && echo "FAIL: old var found" || echo "OK: embedder.py clean"

# 3. Run unit tests
uv run pytest tests/unit/search/test_db.py -v

# 4. Test mask_password function
python -c "from cocosearch.config import mask_password; print(mask_password('postgresql://user:secret@host:5432/db'))"
# Expected output: postgresql://user:***@host:5432/db
```
</verification>

<success_criteria>
1. `src/cocosearch/search/db.py` reads COCOSEARCH_DATABASE_URL
2. `src/cocosearch/indexer/embedder.py` reads COCOSEARCH_OLLAMA_URL
3. `src/cocosearch/config/env_validation.py` exists with validation functions
4. Unit tests pass with updated env var names
5. No references to COCOINDEX_DATABASE_URL or OLLAMA_HOST in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/20-env-var-standardization/20-01-SUMMARY.md`
</output>
