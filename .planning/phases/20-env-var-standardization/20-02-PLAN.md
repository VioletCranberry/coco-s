---
phase: 20-env-var-standardization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/integration/test_e2e_indexing.py
  - tests/integration/test_e2e_search.py
  - tests/integration/test_e2e_devops.py
  - tests/fixtures/ollama_integration.py
autonomous: true

must_haves:
  truths:
    - "Integration tests set COCOSEARCH_DATABASE_URL for subprocess environment"
    - "Integration tests set COCOSEARCH_OLLAMA_URL for subprocess environment"
    - "Ollama fixture sets COCOSEARCH_OLLAMA_URL instead of OLLAMA_HOST"
  artifacts:
    - path: "tests/integration/test_e2e_indexing.py"
      provides: "E2E indexing tests with COCOSEARCH_* env vars"
      contains: "COCOSEARCH_DATABASE_URL"
    - path: "tests/integration/test_e2e_search.py"
      provides: "E2E search tests with COCOSEARCH_* env vars"
      contains: "COCOSEARCH_DATABASE_URL"
    - path: "tests/integration/test_e2e_devops.py"
      provides: "E2E DevOps tests with COCOSEARCH_* env vars"
      contains: "COCOSEARCH_DATABASE_URL"
    - path: "tests/fixtures/ollama_integration.py"
      provides: "Ollama fixture with COCOSEARCH_OLLAMA_URL"
      contains: "COCOSEARCH_OLLAMA_URL"
  key_links:
    - from: "tests/integration/*.py"
      to: "subprocess environment"
      via: "env dict passed to subprocess.run"
      pattern: 'env\\["COCOSEARCH_DATABASE_URL"\\]'
---

<objective>
Update all integration tests and fixtures to use standardized COCOSEARCH_* environment variable names instead of legacy COCOINDEX_DATABASE_URL and OLLAMA_HOST.

Purpose: Ensure integration tests pass with the new env var naming convention.

Output: Updated integration tests and ollama fixture with COCOSEARCH_* env vars.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-env-var-standardization/20-CONTEXT.md
@tests/integration/test_e2e_indexing.py
@tests/integration/test_e2e_search.py
@tests/integration/test_e2e_devops.py
@tests/fixtures/ollama_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update E2E indexing tests</name>
  <files>tests/integration/test_e2e_indexing.py</files>
  <action>
In `tests/integration/test_e2e_indexing.py`, find and replace all occurrences:

1. Change `env["COCOINDEX_DATABASE_URL"]` to `env["COCOSEARCH_DATABASE_URL"]`
2. Change `env["OLLAMA_HOST"]` to `env["COCOSEARCH_OLLAMA_URL"]`
3. Update any print/debug statements that reference these variables:
   - `print(f"COCOINDEX_DATABASE_URL: {env['COCOINDEX_DATABASE_URL']}")` becomes
   - `print(f"COCOSEARCH_DATABASE_URL: {env['COCOSEARCH_DATABASE_URL']}")`
   - Similarly for OLLAMA_HOST -> COCOSEARCH_OLLAMA_URL

This is a straightforward search-and-replace across the file.
  </action>
  <verify>
    grep -c "COCOSEARCH_DATABASE_URL" tests/integration/test_e2e_indexing.py
    grep -c "COCOSEARCH_OLLAMA_URL" tests/integration/test_e2e_indexing.py
    grep "COCOINDEX_DATABASE_URL" tests/integration/test_e2e_indexing.py || echo "No old refs - good"
    grep "OLLAMA_HOST" tests/integration/test_e2e_indexing.py || echo "No old refs - good"
  </verify>
  <done>
    - All COCOINDEX_DATABASE_URL references replaced with COCOSEARCH_DATABASE_URL
    - All OLLAMA_HOST references replaced with COCOSEARCH_OLLAMA_URL
    - No legacy env var names remain
  </done>
</task>

<task type="auto">
  <name>Task 2: Update E2E search and devops tests</name>
  <files>
    tests/integration/test_e2e_search.py
    tests/integration/test_e2e_devops.py
  </files>
  <action>
In `tests/integration/test_e2e_search.py`:
1. Change `env["COCOINDEX_DATABASE_URL"]` to `env["COCOSEARCH_DATABASE_URL"]`
2. Change `env["OLLAMA_HOST"]` to `env["COCOSEARCH_OLLAMA_URL"]`

In `tests/integration/test_e2e_devops.py`:
1. Change `env["COCOINDEX_DATABASE_URL"]` to `env["COCOSEARCH_DATABASE_URL"]`
2. Change `env["OLLAMA_HOST"]` to `env["COCOSEARCH_OLLAMA_URL"]`

Both files follow the same pattern as test_e2e_indexing.py.
  </action>
  <verify>
    grep "COCOINDEX_DATABASE_URL\|OLLAMA_HOST" tests/integration/test_e2e_search.py || echo "search tests clean"
    grep "COCOINDEX_DATABASE_URL\|OLLAMA_HOST" tests/integration/test_e2e_devops.py || echo "devops tests clean"
  </verify>
  <done>
    - test_e2e_search.py uses COCOSEARCH_* env vars
    - test_e2e_devops.py uses COCOSEARCH_* env vars
    - No legacy env var names remain in either file
  </done>
</task>

<task type="auto">
  <name>Task 3: Update ollama fixture</name>
  <files>tests/fixtures/ollama_integration.py</files>
  <action>
In `tests/fixtures/ollama_integration.py`:
1. Change all references from `OLLAMA_HOST` to `COCOSEARCH_OLLAMA_URL`
2. Update the variable names from `original_host` to `original_url` for clarity
3. Update comments to reflect the new naming

Specific changes:
- `original_host = os.environ.get("OLLAMA_HOST")` becomes `original_url = os.environ.get("COCOSEARCH_OLLAMA_URL")`
- `os.environ["OLLAMA_HOST"] = ollama_service` becomes `os.environ["COCOSEARCH_OLLAMA_URL"] = ollama_service`
- In cleanup: `os.environ["OLLAMA_HOST"] = original_host` becomes `os.environ["COCOSEARCH_OLLAMA_URL"] = original_url`
- `elif "OLLAMA_HOST" in os.environ:` becomes `elif "COCOSEARCH_OLLAMA_URL" in os.environ:`
- `del os.environ["OLLAMA_HOST"]` becomes `del os.environ["COCOSEARCH_OLLAMA_URL"]`
- Update comment from "Set OLLAMA_HOST environment variable for CocoIndex" to "Set COCOSEARCH_OLLAMA_URL environment variable"
- Update comment from "Restore original OLLAMA_HOST" to "Restore original COCOSEARCH_OLLAMA_URL"
  </action>
  <verify>
    grep "OLLAMA_HOST" tests/fixtures/ollama_integration.py || echo "No OLLAMA_HOST refs - good"
    grep -c "COCOSEARCH_OLLAMA_URL" tests/fixtures/ollama_integration.py
  </verify>
  <done>
    - ollama_integration.py uses COCOSEARCH_OLLAMA_URL throughout
    - Variable names updated from original_host to original_url
    - Comments updated to reflect new naming
    - No legacy OLLAMA_HOST references remain
  </done>
</task>

</tasks>

<verification>
Run verification commands:
```bash
# 1. Check no legacy env var names remain
grep -r "COCOINDEX_DATABASE_URL\|OLLAMA_HOST" tests/integration/ tests/fixtures/ollama_integration.py && echo "FAIL: old vars found" || echo "OK: all clean"

# 2. Verify new env var names are present
grep -l "COCOSEARCH_DATABASE_URL" tests/integration/*.py | wc -l
# Expected: 3 files

grep -l "COCOSEARCH_OLLAMA_URL" tests/integration/*.py tests/fixtures/ollama_integration.py | wc -l
# Expected: 4 files

# 3. Syntax check (ensure files are valid Python)
python -m py_compile tests/integration/test_e2e_indexing.py
python -m py_compile tests/integration/test_e2e_search.py
python -m py_compile tests/integration/test_e2e_devops.py
python -m py_compile tests/fixtures/ollama_integration.py
```
</verification>

<success_criteria>
1. No references to COCOINDEX_DATABASE_URL in integration tests
2. No references to OLLAMA_HOST in integration tests or ollama fixture
3. All integration test files use COCOSEARCH_DATABASE_URL
4. All files use COCOSEARCH_OLLAMA_URL
5. All Python files are syntactically valid
</success_criteria>

<output>
After completion, create `.planning/phases/20-env-var-standardization/20-02-SUMMARY.md`
</output>
