---
phase: 27-hybrid-search-foundation
plan: 02
type: execute
wave: 2
depends_on: ["27-01"]
files_modified:
  - src/cocosearch/search/query.py
  - src/cocosearch/search/db.py
  - tests/unit/test_search_query.py
autonomous: true

must_haves:
  truths:
    - "Search works on indexes that lack content_text column (graceful degradation)"
    - "Search detects hybrid search capability at runtime via schema inspection"
    - "Warning logged when hybrid columns unavailable (not an error)"
    - "Pre-v1.7 indexes continue to work with vector-only search"
  artifacts:
    - path: "src/cocosearch/search/query.py"
      provides: "Hybrid search capability detection and graceful degradation"
      contains: "_has_content_text_column"
    - path: "src/cocosearch/search/db.py"
      provides: "Schema inspection helper for hybrid search detection"
      contains: "check_column_exists"
    - path: "tests/unit/test_search_query.py"
      provides: "Tests for graceful degradation behavior"
      contains: "hybrid"
  key_links:
    - from: "src/cocosearch/search/query.py"
      to: "src/cocosearch/search/db.py"
      via: "check_column_exists for runtime capability detection"
      pattern: "check_column_exists.*content_text"
---

<objective>
Add graceful degradation logic so pre-v1.7 indexes work without the new hybrid search columns.

Purpose: Ensure backward compatibility (HYBR-07) so users upgrading to v1.7 can continue using existing indexes with vector-only search until they re-index. This follows the established pattern from v1.2 DevOps metadata columns.

Output: Updated query.py with hybrid column detection, db.py helper function, unit tests for degradation.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/research/ARCHITECTURE_SEARCH_ENHANCEMENTS.md
@.planning/research/PITFALLS-search-enhancements.md

@src/cocosearch/search/query.py
@src/cocosearch/search/db.py

# Reference: Plan 01 added content_text to indexing pipeline
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add schema inspection helper to db.py</name>
  <files>src/cocosearch/search/db.py</files>
  <action>
Read src/cocosearch/search/db.py first to understand existing patterns.

Add a helper function to check if a column exists in a table:

```python
def check_column_exists(table_name: str, column_name: str) -> bool:
    """Check if a column exists in a table.

    Used for graceful degradation when schema versions differ.
    For example, pre-v1.7 indexes lack content_text column for hybrid search.

    Args:
        table_name: Full table name (e.g., "codeindex_myproject__myproject_chunks")
        column_name: Column name to check (e.g., "content_text")

    Returns:
        True if column exists, False otherwise.
    """
    pool = get_connection_pool()
    with pool.connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT EXISTS (
                    SELECT 1 FROM information_schema.columns
                    WHERE table_name = %s AND column_name = %s
                )
            """, (table_name, column_name))
            result = cur.fetchone()
            return result[0] if result else False
```

This helper enables runtime detection of schema capabilities, following the established graceful degradation pattern.
  </action>
  <verify>
Read db.py and verify:
1. check_column_exists function is present
2. Uses information_schema.columns for detection
3. Returns bool
4. Has docstring explaining purpose
  </verify>
  <done>
Schema inspection helper allows runtime detection of hybrid search capability.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add hybrid column detection to query.py</name>
  <files>src/cocosearch/search/query.py</files>
  <action>
Read src/cocosearch/search/query.py and understand the existing _has_metadata_columns pattern (lines 76-78, 154-167, 232-294).

Add similar module-level flags and detection for hybrid search columns:

1. Add module-level flags after the existing metadata flags (~line 78):
```python
# Module-level flag for hybrid search column availability (pre-v1.7 graceful degradation)
_has_content_text_column = True
_hybrid_warning_emitted = False
```

2. Add detection logic in the search() function. Follow the existing pattern:
   - On first search, check if content_text column exists
   - If UndefinedColumn error (or proactive check), set _has_content_text_column = False
   - Log warning once: "Index lacks hybrid search columns. Run 'cocosearch index' to enable hybrid search."
   - Continue with vector-only search

3. The actual hybrid search query will be added in Phase 28. For now, just set up the detection infrastructure:
```python
# Check for hybrid search capability (content_text column)
# This prepares for Phase 28 hybrid search implementation
if _has_content_text_column:
    # Future: include content_text in SELECT for hybrid search
    pass
```

Key pattern to follow from existing code:
- Module-level flags persist across function calls
- Warning logged only once per session
- Search continues to work even without new columns

Import check_column_exists from db.py for proactive column detection:
```python
from cocosearch.search.db import get_connection_pool, get_table_name, check_column_exists
```

Add proactive check early in search() function (after getting table_name):
```python
global _has_content_text_column, _hybrid_warning_emitted

# Proactively check for hybrid search columns on first call
if _has_content_text_column and not _hybrid_warning_emitted:
    table_name = get_table_name(index_name)
    if not check_column_exists(table_name, "content_text"):
        _has_content_text_column = False
        logger.warning(
            "Index lacks hybrid search columns (content_text). "
            "Run 'cocosearch index' to enable hybrid search."
        )
        _hybrid_warning_emitted = True
```
  </action>
  <verify>
Read query.py and verify:
1. _has_content_text_column and _hybrid_warning_emitted flags exist
2. check_column_exists imported from db.py
3. Detection logic added in search() function
4. Warning message mentions hybrid search and upgrade path
  </verify>
  <done>
Search function detects hybrid column availability and degrades gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for graceful degradation</name>
  <files>tests/unit/test_search_query.py</files>
  <action>
Read tests/unit/test_search_query.py first to understand existing test patterns.

Add tests for hybrid search graceful degradation:

```python
class TestHybridSearchGracefulDegradation:
    """Tests for hybrid search column detection and graceful degradation."""

    def test_check_column_exists_detects_missing_column(self, mock_pool):
        """Test that check_column_exists returns False for missing columns."""
        # Mock cursor to return False (column not found)
        mock_cursor = mock_pool.connection().__enter__().cursor().__enter__()
        mock_cursor.fetchone.return_value = (False,)

        from cocosearch.search.db import check_column_exists
        result = check_column_exists("test_table", "nonexistent_column")

        assert result is False

    def test_check_column_exists_detects_existing_column(self, mock_pool):
        """Test that check_column_exists returns True for existing columns."""
        mock_cursor = mock_pool.connection().__enter__().cursor().__enter__()
        mock_cursor.fetchone.return_value = (True,)

        from cocosearch.search.db import check_column_exists
        result = check_column_exists("test_table", "existing_column")

        assert result is True

    def test_search_continues_without_hybrid_columns(self, mock_pool, mock_embedding):
        """Test that search works even when content_text column is missing."""
        # Setup: column check returns False (pre-v1.7 index)
        # Search should still work with vector-only mode

        import cocosearch.search.query as query_module
        # Reset module state for test isolation
        query_module._has_content_text_column = True
        query_module._hybrid_warning_emitted = False

        # Mock column check to return False
        with patch('cocosearch.search.query.check_column_exists', return_value=False):
            with patch.object(query_module, 'logger') as mock_logger:
                # This should trigger the warning but not raise an error
                # The actual search execution will depend on other mocks
                # At minimum, verify the warning is logged

                # Trigger the check
                query_module._has_content_text_column = True  # Reset
                # ... actual search call would go here in integration test

        # Verify flag was set correctly
        # (Full integration test in tests/integration/)
```

Follow the existing patterns in the test file for mocking and fixtures. The tests should verify:
1. check_column_exists works correctly
2. Search continues even when hybrid columns are missing
3. Warning is logged only once

Note: If the test file doesn't have these specific fixtures, adapt to use existing patterns or create minimal mocks.
  </action>
  <verify>
Run: `cd /Users/fedorzhdanov/GIT/personal/coco-s && uv run pytest tests/unit/test_search_query.py -v --tb=short -k "hybrid or column"`

Tests should pass.
  </verify>
  <done>
Unit tests verify hybrid search graceful degradation behavior.
  </done>
</task>

</tasks>

<verification>
1. Read src/cocosearch/search/db.py and confirm check_column_exists function
2. Read src/cocosearch/search/query.py and confirm hybrid detection logic
3. Run unit tests: `uv run pytest tests/unit/ -v --tb=short -k "hybrid or column or degradation"`
4. Run all unit tests to verify no regressions: `uv run pytest tests/unit/ -v --tb=short`
</verification>

<success_criteria>
- [x] check_column_exists helper added to db.py
- [x] _has_content_text_column and _hybrid_warning_emitted flags added to query.py
- [x] Proactive column detection in search() function
- [x] Warning logged once when hybrid columns missing
- [x] Unit tests for graceful degradation pass
- [x] All existing unit tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-hybrid-search-foundation/27-02-SUMMARY.md`
</output>
