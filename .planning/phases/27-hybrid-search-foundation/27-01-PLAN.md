---
phase: 27-hybrid-search-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cocosearch/indexer/flow.py
  - tests/unit/test_indexer_flow.py
autonomous: true

must_haves:
  truths:
    - "CocoIndex flow collects content_text field during indexing"
    - "Chunk text is passed through to PostgreSQL storage unchanged"
    - "Existing indexes without content_text column work (graceful degradation)"
  artifacts:
    - path: "src/cocosearch/indexer/flow.py"
      provides: "Modified indexing pipeline with content_text collection"
      contains: "content_text=chunk"
    - path: "tests/unit/test_indexer_flow.py"
      provides: "Unit tests for content_text field in flow"
      contains: "content_text"
  key_links:
    - from: "src/cocosearch/indexer/flow.py"
      to: "cocoindex.storages.Postgres()"
      via: "code_embeddings.collect() with content_text field"
      pattern: "content_text.*chunk"
---

<objective>
Modify the CocoIndex indexing pipeline to store chunk text content alongside embeddings.

Purpose: Enable keyword search (BM25-style) by storing the actual text content that will later be converted to tsvector for full-text search. This is the foundation for hybrid search in Phase 28.

Output: Updated flow.py with content_text field collection, unit tests validating the new field.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/research/ARCHITECTURE_SEARCH_ENHANCEMENTS.md
@.planning/research/PITFALLS-search-enhancements.md

@src/cocosearch/indexer/flow.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add content_text field to indexing flow</name>
  <files>src/cocosearch/indexer/flow.py</files>
  <action>
Modify create_code_index_flow() to store chunk text in the database.

In the chunk processing section (around line 75-92), add content_text field:

```python
# Step 4: Process each chunk
with file["chunks"].row() as chunk:
    # Generate embedding via Ollama using shared transform
    chunk["embedding"] = chunk["text"].call(code_to_embedding)

    # Extract DevOps metadata (block_type, hierarchy, language_id)
    chunk["metadata"] = chunk["text"].transform(
        extract_devops_metadata,
        language=file["extension"],
    )

    # NEW: Store chunk text for keyword search (v1.7 hybrid search)
    # This enables BM25-style full-text search via PostgreSQL tsvector

    # Collect with metadata (now includes content_text for hybrid search)
    code_embeddings.collect(
        filename=file["filename"],
        location=chunk["location"],
        embedding=chunk["embedding"],
        content_text=chunk["text"],  # NEW: Store actual text for keyword indexing
        block_type=chunk["metadata"]["block_type"],
        hierarchy=chunk["metadata"]["hierarchy"],
        language_id=chunk["metadata"]["language_id"],
    )
```

Key points:
- content_text receives chunk["text"] directly (no transformation needed)
- This is the raw chunk text that Tree-sitter extracted
- PostgreSQL will automatically handle the TEXT column creation
- Add comment explaining this is for v1.7 hybrid search

Note: CocoIndex handles schema creation automatically. When the flow runs with the new field, it will ALTER TABLE to add the column.
  </action>
  <verify>
Read flow.py and verify:
1. content_text=chunk["text"] is present in code_embeddings.collect()
2. Comment explains purpose (hybrid search)
3. No other changes to the flow logic
  </verify>
  <done>
Indexing flow includes content_text field that stores chunk text for keyword search.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for content_text field</name>
  <files>tests/unit/test_indexer_flow.py</files>
  <action>
Add tests to verify the content_text field is properly collected.

First, read the existing test file to understand the testing patterns used.

Add tests that verify:
1. The flow definition includes content_text in the collector
2. Integration behavior when CocoIndex processes the flow (if there's a pattern for this)

Test structure should follow existing patterns in the file. Key test:

```python
def test_flow_collects_content_text_for_hybrid_search():
    """Test that content_text field is collected for hybrid search."""
    # Test that the flow configuration includes content_text
    # This validates the flow definition, not actual database storage
    # (Database storage is tested in integration tests)
    ...
```

If the test file doesn't exist, create it following the project's test conventions from other test files (check tests/unit/ for patterns).

The test should verify that content_text is part of the flow's collector configuration, which enables downstream hybrid search.
  </action>
  <verify>
Run: `cd /Users/fedorzhdanov/GIT/personal/coco-s && uv run pytest tests/unit/test_indexer_flow.py -v --tb=short`

Tests should pass. If test file is new, verify it follows project conventions.
  </verify>
  <done>
Unit tests verify content_text field is collected in the indexing flow.
  </done>
</task>

</tasks>

<verification>
1. Read src/cocosearch/indexer/flow.py and confirm content_text field in collect()
2. Run unit tests: `uv run pytest tests/unit/ -v --tb=short -k "flow or content_text"`
3. Verify no regressions: `uv run pytest tests/unit/ -v --tb=short`
</verification>

<success_criteria>
- [x] content_text=chunk["text"] added to code_embeddings.collect() in flow.py
- [x] Comment explains this is for v1.7 hybrid search
- [x] Unit tests for content_text field pass
- [x] All existing unit tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/27-hybrid-search-foundation/27-01-SUMMARY.md`
</output>
