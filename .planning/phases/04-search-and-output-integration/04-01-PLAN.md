---
phase: 04-search-and-output-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cocosearch/search/query.py
  - src/cocosearch/cli.py
  - tests/search/test_query.py
autonomous: true

must_haves:
  truths:
    - "SearchResult contains block_type, hierarchy, language_id fields"
    - "Search results include block_type, hierarchy, language_id metadata"
    - "DevOps language filters (hcl, dockerfile, bash) work via language_id column"
    - "Aliases terraform, shell, sh resolve to canonical names hcl, bash, bash"
    - "Comma-separated --lang values filter across multiple languages"
    - "Unrecognized --lang value produces error listing available languages"
    - "Pre-v1.2 index without metadata columns returns results with empty string metadata instead of crashing"
    - "Pre-v1.2 index emits one-time warning about missing metadata columns"
    - "Language filter on pre-v1.2 index produces clear upgrade error"
    - "CLI --lang help text lists DevOps languages and aliases"
  artifacts:
    - path: "src/cocosearch/search/query.py"
      provides: "Extended SearchResult with metadata fields, DevOps language filter with aliases, graceful degradation"
      contains: "block_type"
    - path: "src/cocosearch/cli.py"
      provides: "Updated --lang help text with DevOps language names"
      contains: "hcl"
    - path: "tests/search/test_query.py"
      provides: "Tests for new metadata fields, DevOps filters, aliases, graceful degradation"
      contains: "test_devops_language_filter"
  key_links:
    - from: "src/cocosearch/search/query.py"
      to: "PostgreSQL chunks table"
      via: "SQL SELECT with metadata columns"
      pattern: "block_type.*hierarchy.*language_id"
    - from: "src/cocosearch/search/query.py"
      to: "Pre-v1.2 fallback"
      via: "try/except on metadata column access"
      pattern: "except.*UndefinedColumn|except.*ProgrammingError"
    - from: "src/cocosearch/search/query.py"
      to: "Alias resolution"
      via: "LANGUAGE_ALIASES dict mapping terraform->hcl, shell->bash, sh->bash"
      pattern: "LANGUAGE_ALIASES"
---

<objective>
Extend the search query layer to select DevOps metadata columns from PostgreSQL, support DevOps language filtering via language_id (with aliases), degrade gracefully on pre-v1.2 indexes, and update CLI help text.

Purpose: The search layer is the data gateway for all output consumers (CLI, MCP). Metadata must flow through SearchResult before formatters or MCP can surface it. Graceful degradation prevents crashes on older indexes. Aliases honor REQ-20 by accepting `terraform`, `shell`, `sh` and resolving them to canonical names.

Output: Updated `query.py` with extended SearchResult, metadata-aware SQL, DevOps language support with aliases, and graceful degradation. Updated `cli.py` with DevOps language help text. Updated `test_query.py` with comprehensive tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-search-and-output-integration/04-CONTEXT.md
@src/cocosearch/search/query.py
@src/cocosearch/search/db.py
@src/cocosearch/cli.py
@tests/search/test_query.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SearchResult, SQL queries, language filter with aliases, and graceful degradation</name>
  <files>src/cocosearch/search/query.py, src/cocosearch/cli.py</files>
  <action>
  1. Add three new fields to `SearchResult` dataclass:
     - `block_type: str = ""` (default empty string)
     - `hierarchy: str = ""` (default empty string)
     - `language_id: str = ""` (default empty string)
     All three MUST default to empty string (not None) per project convention.

  2. Add DevOps language constants. Create a new dict `DEVOPS_LANGUAGES` mapping canonical names to language_id values used in the database:
     ```python
     DEVOPS_LANGUAGES = {
         "hcl": "hcl",
         "dockerfile": "dockerfile",
         "bash": "bash",
     }
     ```
     Create an alias mapping for REQ-20 compatibility:
     ```python
     LANGUAGE_ALIASES = {
         "terraform": "hcl",
         "shell": "bash",
         "sh": "bash",
     }
     ```
     Also create `ALL_LANGUAGES` combining existing LANGUAGE_EXTENSIONS keys with DEVOPS_LANGUAGES keys for validation/suggestions. The alias keys (terraform, shell, sh) should NOT appear in ALL_LANGUAGES -- they are resolved silently before validation.

  3. Add a validation function `validate_language_filter(lang_str: str) -> list[str]`:
     - Split `lang_str` on commas, strip whitespace
     - For each value, first resolve through `LANGUAGE_ALIASES` (e.g., "terraform" -> "hcl", "shell" -> "bash", "sh" -> "bash"). If the value is an alias, replace it with the canonical name silently.
     - Then check if the (possibly resolved) value exists in `ALL_LANGUAGES`
     - If any unrecognized after alias resolution, raise `ValueError` with message: "Unknown language(s): {unknown}. Available: {sorted list of ALL_LANGUAGES keys}"
     - Return list of validated canonical language names

  4. Rewrite the `search()` function SQL to include metadata columns with graceful degradation:
     - First attempt: SELECT with `block_type, hierarchy, language_id` columns alongside existing columns
     - Wrap the query execution in try/except catching `psycopg.errors.UndefinedColumn` (import from psycopg.errors)
     - On `UndefinedColumn` exception: set a module-level flag `_has_metadata_columns = False`, re-execute without metadata columns, and populate SearchResult with empty strings for metadata fields
     - After setting `_has_metadata_columns = False`, emit a one-time warning: `logging.warning("Index lacks metadata columns. Run 'cocosearch index' to upgrade.")` -- use Python's `logging` module (import at top of file). The module-level flag ensures this warning fires only once per session (subsequent queries skip the failing SQL path entirely).
     - Use the module-level flag to skip metadata columns on subsequent queries within the same session (avoiding repeated failures)

  5. Update language filter logic in `search()`:
     - Call `validate_language_filter()` on the language_filter parameter before building SQL
     - For each validated language name:
       - If it's in `DEVOPS_LANGUAGES`: add `language_id = %s` condition using the DEVOPS_LANGUAGES value
       - If it's in `LANGUAGE_EXTENSIONS`: use existing `filename LIKE %s` extension patterns
     - Combine all conditions with OR for multi-language support
     - If language filter is used and `_has_metadata_columns is False` (pre-v1.2 index): raise `ValueError("Language filtering requires v1.2 index. Run 'cocosearch index' to upgrade.")`
       NOTE: Only raise this error for DevOps language filters (hcl, dockerfile, bash). Extension-based filters (python, typescript) should still work on pre-v1.2 indexes.

  6. Update SearchResult construction from query rows:
     - When metadata columns present: populate block_type, hierarchy, language_id from row[4], row[5], row[6]
     - When metadata columns absent: use defaults (empty strings)

  7. Update CLI help text in `src/cocosearch/cli.py`:
     - Change the `--lang` argument help from:
       `help="Filter by language (e.g., python, typescript)"`
       to:
       `help="Filter by language (e.g., python, typescript, hcl, dockerfile, bash). Aliases: terraform=hcl, shell/sh=bash"`
     - This documents both DevOps languages and alias support.
  </action>
  <verify>
  Run `python -c "from cocosearch.search.query import SearchResult, DEVOPS_LANGUAGES, LANGUAGE_ALIASES, validate_language_filter; r = SearchResult('f', 0, 1, 0.5); print(r.block_type, r.hierarchy, r.language_id); validate_language_filter('python,hcl')"` -- should print three empty strings and not raise.
  Run `python -c "from cocosearch.search.query import validate_language_filter; print(validate_language_filter('terraform'))"` -- should return ['hcl'] (alias resolved, no error).
  Run `python -c "from cocosearch.search.query import validate_language_filter; validate_language_filter('foobar')"` -- should raise ValueError with suggestion list.
  Run `python -c "import ast; src = open('src/cocosearch/cli.py').read(); assert 'hcl' in src; print('CLI help updated')"` -- confirm help text updated.
  </verify>
  <done>
  - SearchResult has block_type, hierarchy, language_id fields defaulting to ""
  - DEVOPS_LANGUAGES dict maps hcl, dockerfile, bash
  - LANGUAGE_ALIASES dict maps terraform->hcl, shell->bash, sh->bash
  - validate_language_filter resolves aliases before validation, rejects unknowns with suggestions
  - SQL queries attempt metadata columns, fall back gracefully on UndefinedColumn
  - On fallback, emits one-time logging.warning about missing metadata columns
  - DevOps language filter uses language_id column, extension-based filter uses filename LIKE
  - Pre-v1.2 index + DevOps language filter raises clear upgrade error
  - CLI --lang help text includes DevOps languages and aliases
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for metadata fields, aliases, DevOps language filter, and graceful degradation</name>
  <files>tests/search/test_query.py</files>
  <action>
  Add new test classes to the existing test file, following the established pattern of using `mock_code_to_embedding` and `mock_db_pool` fixtures with `patch`.

  1. **Update TestSearchResult**:
     - Add `test_metadata_fields_default_empty_strings`: Create SearchResult without specifying metadata fields, assert block_type == "", hierarchy == "", language_id == ""
     - Add `test_metadata_fields_set`: Create SearchResult with block_type="resource", hierarchy="resource.aws_s3_bucket.data", language_id="hcl", verify values

  2. **New class TestValidateLanguageFilter**:
     - `test_single_language`: validate_language_filter("python") returns ["python"]
     - `test_multiple_languages`: validate_language_filter("hcl,bash") returns ["hcl", "bash"]
     - `test_strips_whitespace`: validate_language_filter("hcl , bash") returns ["hcl", "bash"]
     - `test_devops_languages`: validate_language_filter("hcl") returns ["hcl"], same for "dockerfile", "bash"
     - `test_alias_terraform_resolves_to_hcl`: validate_language_filter("terraform") returns ["hcl"]
     - `test_alias_shell_resolves_to_bash`: validate_language_filter("shell") returns ["bash"]
     - `test_alias_sh_resolves_to_bash`: validate_language_filter("sh") returns ["bash"]
     - `test_mixed_alias_and_canonical`: validate_language_filter("terraform,bash") returns ["hcl", "bash"]
     - `test_unknown_raises_valueerror`: validate_language_filter("foobar") raises ValueError containing "Unknown language"
     - `test_mixed_known_unknown_raises`: validate_language_filter("python,foobar") raises ValueError

  3. **New class TestDevOpsLanguageFilter**:
     - `test_hcl_filter_uses_language_id`: Mock DB to return rows with metadata columns. Call search with language_filter="hcl". Verify SQL contains "language_id" condition (not filename LIKE).
     - `test_dockerfile_filter_uses_language_id`: Same pattern for dockerfile.
     - `test_multi_language_filter`: Call search with language_filter="hcl,python". Verify SQL contains both language_id and filename LIKE conditions combined with OR.
     - `test_alias_terraform_filters_as_hcl`: Call search with language_filter="terraform". Verify SQL contains language_id = 'hcl' condition.

  4. **New class TestGracefulDegradation**:
     - `test_pre_v12_index_returns_empty_metadata`: Mock the cursor.execute to raise `psycopg.errors.UndefinedColumn` on first call (with metadata columns), then succeed on second call (without). Verify results have block_type="", hierarchy="", language_id="" and no exception propagated.
     - `test_pre_v12_emits_warning`: Same scenario as above. Verify that `logging.warning` was called with a message containing "metadata columns" and "upgrade".
     - `test_pre_v12_devops_filter_raises_error`: After setting the module-level `_has_metadata_columns = False`, call search with language_filter="hcl". Verify ValueError raised with upgrade message.
     - `test_pre_v12_extension_filter_still_works`: After setting `_has_metadata_columns = False`, call search with language_filter="python". Verify it works (extension-based filters don't need metadata columns).

  Import `validate_language_filter`, `DEVOPS_LANGUAGES`, `LANGUAGE_ALIASES`, and `ALL_LANGUAGES` at the top of the file alongside existing imports.

  IMPORTANT: After each test that modifies `_has_metadata_columns`, reset it to True to avoid test pollution. Use a fixture or manual reset in teardown.
  </action>
  <verify>
  Run `cd /Users/fzhdanov/GIT/personal/coco-s && python -m pytest tests/search/test_query.py -v` -- all existing and new tests pass.
  </verify>
  <done>
  - TestSearchResult has metadata field tests
  - TestValidateLanguageFilter covers single, multi, DevOps, aliases (terraform, shell, sh), unknown, and mixed
  - TestDevOpsLanguageFilter verifies language_id SQL for DevOps, filename LIKE for extensions, and alias resolution
  - TestGracefulDegradation verifies fallback on UndefinedColumn, one-time warning emission, upgrade error for DevOps filter, and extension filter on pre-v1.2
  - All tests pass
  </done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/search/test_query.py -v` -- all tests pass (existing + new)
2. `python -c "from cocosearch.search.query import SearchResult; r = SearchResult('f', 0, 1, 0.5); assert r.block_type == ''; assert r.hierarchy == ''; assert r.language_id == ''"` -- defaults work
3. `python -c "from cocosearch.search.query import validate_language_filter; assert validate_language_filter('hcl,python') == ['hcl', 'python']"` -- multi-language works
4. `python -c "from cocosearch.search.query import validate_language_filter; assert validate_language_filter('terraform') == ['hcl']"` -- alias resolved
5. `python -c "from cocosearch.search.query import validate_language_filter; validate_language_filter('foobar')"` -- raises ValueError
6. `grep -q 'hcl' src/cocosearch/cli.py` -- CLI help text updated
</verification>

<success_criteria>
- SearchResult has 3 new metadata fields defaulting to empty strings
- SQL queries select metadata columns with try/except fallback
- One-time logging.warning emitted when metadata columns missing
- DevOps languages (hcl, dockerfile, bash) filter via language_id column
- Aliases (terraform->hcl, shell->bash, sh->bash) resolve transparently
- Extension-based languages still use filename LIKE
- Comma-separated multi-language filtering works
- Unrecognized language names raise ValueError with suggestions
- Pre-v1.2 index gracefully degrades to empty metadata
- Pre-v1.2 index + DevOps language filter produces clear upgrade error
- CLI --lang help text includes DevOps languages and aliases
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-search-and-output-integration/04-01-SUMMARY.md`
</output>
