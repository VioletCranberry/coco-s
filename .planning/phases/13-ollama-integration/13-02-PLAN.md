---
phase: 13-ollama-integration
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - tests/integration/test_ollama.py
autonomous: true

must_haves:
  truths:
    - "Embeddings have exactly 768 dimensions (nomic-embed-text)"
    - "Embedding values are floats in reasonable range (not NaN/Inf)"
    - "Similar texts produce similar embeddings (cosine > 0.8)"
    - "Dissimilar texts produce different embeddings (cosine < 0.7)"
  artifacts:
    - path: "tests/integration/test_ollama.py"
      provides: "Ollama embedding integration tests"
      min_lines: 80
  key_links:
    - from: "tests/integration/test_ollama.py"
      to: "warmed_ollama fixture"
      via: "pytest fixture injection"
      pattern: "def test_.*warmed_ollama"
    - from: "tests/integration/test_ollama.py"
      to: "cocoindex.functions.EmbedText"
      via: "embedding generation"
      pattern: "EmbedText.*OLLAMA"
---

<objective>
Create Ollama integration tests validating embedding dimensions, values, and similarity

Purpose: Verify real Ollama embedding generation produces correct 768-dimensional vectors with reasonable values, and that semantically similar texts produce similar embeddings.

Output: Integration test file with dimension validation, value range checks, and similarity sanity tests
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-ollama-integration/13-CONTEXT.md
@.planning/phases/13-ollama-integration/13-RESEARCH.md
@.planning/phases/13-ollama-integration/13-01-SUMMARY.md
@tests/integration/test_postgresql.py
@tests/fixtures/ollama_integration.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create embedding dimension and value validation tests</name>
  <files>tests/integration/test_ollama.py</files>
  <action>
Create new file tests/integration/test_ollama.py following the structure of test_postgresql.py.

**Module docstring:**
```python
"""Ollama integration tests.

Tests validating real Ollama embedding generation:
- Embedding dimensions (768 for nomic-embed-text)
- Value range checks (floats, not NaN/Inf)
- Similarity sanity (similar texts produce similar embeddings)

These tests require Ollama (native or Docker) and are marked with @pytest.mark.integration.
The marker is auto-applied by tests/integration/conftest.py.
"""
```

**TestEmbeddingGeneration class:**

1. test_embedding_dimensions(warmed_ollama):
   - Generate embedding for sample code text: "def hello_world():\n    print('Hello')"
   - Use cocoindex.functions.EmbedText with api_type=OLLAMA, model="nomic-embed-text"
   - Assert len(embedding) == 768
   - Requirement: OLLAMA-03

2. test_embedding_values_valid(warmed_ollama):
   - Generate embedding for sample text
   - Assert all values are floats (float32 or float64)
   - Assert no NaN values: not any(np.isnan(v))
   - Assert no Inf values: not any(np.isinf(v))
   - Assert values in reasonable range: all(-10 <= v <= 10) (normalized vectors usually smaller but allow margin)
   - Requirement: OLLAMA-03

3. test_embedding_consistent(warmed_ollama):
   - Generate embedding for same text twice
   - Assert embeddings are identical (deterministic model)
   - Requirement: OLLAMA-01

**Note on CocoIndex usage:**
The project uses cocoindex differently than shown in research. Check existing code at cocosearch/indexer/embedder.py for actual usage patterns. The EmbedText function may need to be called via flow or directly - match existing patterns.

Import numpy for array operations. Use appropriate assertion messages.
  </action>
  <verify>
Run: `uv run pytest tests/integration/test_ollama.py::TestEmbeddingGeneration -v -m integration --tb=short`
(Requires native Ollama running or Docker available)

If Ollama unavailable, test should skip with clear message.
  </verify>
  <done>
- test_embedding_dimensions validates 768 dimensions
- test_embedding_values_valid checks for floats, no NaN/Inf
- test_embedding_consistent verifies deterministic output
  </done>
</task>

<task type="auto">
  <name>Task 2: Create similarity sanity tests</name>
  <files>tests/integration/test_ollama.py</files>
  <action>
Add TestEmbeddingSimilarity class to tests/integration/test_ollama.py:

**TestEmbeddingSimilarity class:**

1. test_similar_texts_high_similarity(warmed_ollama):
   - Generate embeddings for semantically similar texts:
     - "Python function for sorting a list"
     - "Python method to sort an array"
   - Calculate cosine similarity
   - Assert similarity > 0.8 (similar texts should be similar)
   - Requirement: OLLAMA-01, validates real embedding behavior

2. test_dissimilar_texts_lower_similarity(warmed_ollama):
   - Generate embeddings for dissimilar texts:
     - "Python function for sorting a list"
     - "Recipe for chocolate cake"
   - Calculate cosine similarity
   - Assert similarity < 0.7 (dissimilar texts should be different)
   - Requirement: OLLAMA-01, validates semantic understanding

3. test_code_vs_natural_language(warmed_ollama):
   - Generate embeddings for:
     - Code: "def sort_list(items): return sorted(items)"
     - Description: "A function that sorts a list"
   - Assert these are reasonably similar (> 0.5) but not identical
   - Validates code embedding works for code search use case

**Cosine similarity helper function:**
```python
def cosine_similarity(a, b):
    """Calculate cosine similarity between two vectors."""
    import numpy as np
    return np.dot(a, b) / (np.linalg.norm(a) * np.linalg.norm(b))
```

Place helper at module level or in test class.
  </action>
  <verify>
Run: `uv run pytest tests/integration/test_ollama.py::TestEmbeddingSimilarity -v -m integration --tb=short`
(Requires native Ollama running or Docker available)

All similarity assertions should pass with reasonable margins.
  </verify>
  <done>
- test_similar_texts_high_similarity verifies similar texts have cosine > 0.8
- test_dissimilar_texts_lower_similarity verifies dissimilar texts have cosine < 0.7
- test_code_vs_natural_language validates code embedding sanity
  </done>
</task>

</tasks>

<verification>
1. Run all Ollama integration tests:
   `uv run pytest tests/integration/test_ollama.py -v -m integration --tb=short`

2. Verify test count (should be 6 tests):
   `uv run pytest tests/integration/test_ollama.py --collect-only -m integration`

3. If Ollama unavailable, verify tests skip gracefully with clear message
</verification>

<success_criteria>
- tests/integration/test_ollama.py exists with 6 tests across 2 test classes
- TestEmbeddingGeneration validates dimensions (768), values (valid floats), consistency
- TestEmbeddingSimilarity validates similar/dissimilar text similarity scores
- All tests use warmed_ollama fixture (not ollama_service directly)
- Tests pass when Ollama available, skip gracefully when unavailable
- Similarity thresholds: > 0.8 for similar, < 0.7 for dissimilar
</success_criteria>

<output>
After completion, create `.planning/phases/13-ollama-integration/13-02-SUMMARY.md`
</output>
