---
phase: 31-context-expansion
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/cocosearch/cli.py
  - src/cocosearch/search/formatter.py
  - tests/unit/search/test_formatter_context.py
autonomous: true

must_haves:
  truths:
    - "User can specify -A/-B/-C flags in CLI"
    - "User can use --no-smart to disable smart expansion"
    - "Context appears in both JSON and pretty output"
  artifacts:
    - path: "src/cocosearch/cli.py"
      provides: "CLI flags for context expansion"
      contains: "-A, -B, -C, --no-smart"
    - path: "src/cocosearch/search/formatter.py"
      provides: "Updated formatters with context expansion"
      contains: "context_expander"
    - path: "tests/unit/search/test_formatter_context.py"
      provides: "Tests for context output formatting"
      min_lines: 80
  key_links:
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/search/formatter.py"
      via: "passes context args to format_pretty/format_json"
      pattern: "context_before.*context_after"
---

<objective>
Add CLI context expansion flags and integrate with output formatters.

Purpose: Enable users to request context lines via -A/-B/-C flags and see them in both JSON and pretty output.
Output: Updated CLI with context flags, updated formatters with grep-style output.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/31-context-expansion/31-CONTEXT.md
@.planning/phases/31-context-expansion/31-01-SUMMARY.md
@src/cocosearch/cli.py
@src/cocosearch/search/formatter.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CLI context flags</name>
  <files>src/cocosearch/cli.py</files>
  <action>
Update `src/cocosearch/cli.py` to add context expansion flags to the search subcommand:

1. **Add new arguments to search_parser:**
   ```python
   search_parser.add_argument(
       "-A", "--after-context",
       type=int,
       default=None,
       metavar="NUM",
       help="Show NUM lines after each match (overrides smart expansion)",
   )
   search_parser.add_argument(
       "-B", "--before-context",
       type=int,
       default=None,
       metavar="NUM",
       help="Show NUM lines before each match (overrides smart expansion)",
   )
   search_parser.add_argument(
       "-C", "--context",  # Note: replaces existing --context
       type=int,
       default=None,
       metavar="NUM",
       help="Show NUM lines before and after each match (overrides smart expansion)",
   )
   search_parser.add_argument(
       "--no-smart",
       action="store_true",
       help="Disable smart context expansion (use exact line counts instead of function boundaries)",
   )
   ```

   Note: The existing `-c, --context` flag (used for context_lines in JSON) needs to be renamed or its behavior unified. Per CONTEXT.md, `-A/-B/-C` override smart expansion. Update the existing `--context` to `-C` for consistency with grep.

2. **Update search_command function:**
   - Parse -A/-B/-C flags into context_before and context_after integers
   - If -C is specified, use it for both before and after
   - -A and -B override -C for their respective directions
   - Pass to format_pretty and format_json calls:
     ```python
     # Determine context parameters
     context_before = args.before_context
     context_after = args.after_context
     if args.context is not None:
         context_before = context_before or args.context
         context_after = context_after or args.context

     smart_context = not args.no_smart
     ```
   - Update format_pretty call:
     ```python
     format_pretty(
         results,
         context_before=context_before,
         context_after=context_after,
         smart_context=smart_context,
         console=console,
     )
     ```
   - Update format_json call similarly

3. **Default behavior:**
   - If no -A/-B/-C specified and smart_context=True (default): expand to function boundaries
   - If no -A/-B/-C specified and --no-smart: show only the matched chunk
   - If -A/-B/-C specified: use those exact line counts regardless of --no-smart
  </action>
  <verify>`cocosearch search --help` shows -A, -B, -C, and --no-smart flags.</verify>
  <done>CLI search command supports -A/-B/-C context flags and --no-smart option.</done>
</task>

<task type="auto">
  <name>Task 2: Update formatters with context expansion</name>
  <files>src/cocosearch/search/formatter.py</files>
  <action>
Update `src/cocosearch/search/formatter.py` to use ContextExpander:

1. **Add imports:**
   ```python
   from cocosearch.search.context_expander import ContextExpander
   ```

2. **Update format_json signature and implementation:**
   ```python
   def format_json(
       results: list[SearchResult],
       context_before: int | None = None,
       context_after: int | None = None,
       smart_context: bool = True,
       include_content: bool = True,
   ) -> str:
   ```

   Implementation changes:
   - Create ContextExpander instance
   - For each result, call expander.get_context_lines()
   - Add context_before and context_after as string fields in JSON:
     ```python
     if context_before is not None or context_after is not None or smart_context:
         before_lines, match_lines, after_lines, is_bof, is_eof = expander.get_context_lines(
             r.filename, start_line, end_line,
             context_before=context_before or 0,
             context_after=context_after or 0,
             smart=smart_context,
             language=_get_language_from_extension(r.filename),
         )
         # Format as newline-separated string
         item["context_before"] = "\n".join(line for _, line in before_lines)
         item["context_after"] = "\n".join(line for _, line in after_lines)
     ```
   - Clear cache after processing all results

3. **Update format_pretty signature and implementation:**
   ```python
   def format_pretty(
       results: list[SearchResult],
       context_before: int | None = None,
       context_after: int | None = None,
       smart_context: bool = True,
       console: Console | None = None,
   ) -> None:
   ```

   Implementation changes:
   - Create ContextExpander instance
   - For each result, get context lines with boundaries
   - Display with grep-style markers (per CONTEXT.md):
     - Context lines: `{line_num}: {line_text}`
     - Match lines: `{line_num}> {line_text}`
   - Show BOF/EOF markers when applicable:
     - `[Beginning of file]` before first line if is_bof
     - `[End of file]` after last line if is_eof
   - Use Rich Syntax only for the matched chunk content, not context
   - Clear cache after processing

4. **Helper function:**
   ```python
   def _get_language_from_extension(filepath: str) -> str | None:
       """Get tree-sitter language name from file extension."""
       ext = os.path.splitext(filepath)[1].lstrip(".")
       # Map from EXTENSION_LANG_MAP to tree-sitter names
       # python, javascript, typescript, go, rust
       lang = EXTENSION_LANG_MAP.get(ext)
       # Map display names to tree-sitter names if different
       mapping = {"python": "python", "javascript": "javascript", ...}
       return mapping.get(lang)
   ```

5. **Backward compatibility:**
   - Keep existing `context_lines` parameter working for legacy callers
   - If old `context_lines` is passed, treat as both context_before and context_after
  </action>
  <verify>
`python -c "from cocosearch.search.formatter import format_json, format_pretty"` succeeds.
`python -c "from cocosearch.search.formatter import format_json; print(format_json.__code__.co_varnames)"` shows context_before, context_after params.
  </verify>
  <done>format_json and format_pretty support context expansion with grep-style output markers.</done>
</task>

<task type="auto">
  <name>Task 3: Add formatter context tests</name>
  <files>tests/unit/search/test_formatter_context.py</files>
  <action>
Create tests at `tests/unit/search/test_formatter_context.py`:

1. **Test JSON output with context:**
   - Test context_before and context_after fields appear in JSON
   - Test smart expansion shows function boundaries
   - Test explicit -A/-B values override smart expansion
   - Test --no-smart disables boundary detection

2. **Test pretty output with context:**
   - Test grep-style markers (`:` for context, `>` for match)
   - Test line numbers are shown
   - Test BOF marker appears when at file start
   - Test EOF marker appears when at file end

3. **Test backward compatibility:**
   - Test old context_lines parameter still works
   - Test format calls without context params work

4. **Mock setup:**
   - Mock SearchResult objects with test file paths
   - Create temp files with known content for testing
   - Use monkeypatch to control ContextExpander behavior if needed

All tests use @pytest.mark.unit decorator.
  </action>
  <verify>`cd /Users/fedorzhdanov/GIT/personal/coco-s && python -m pytest tests/unit/search/test_formatter_context.py -v` passes.</verify>
  <done>Formatter context tests exist and pass, covering JSON and pretty output with grep-style markers.</done>
</task>

</tasks>

<verification>
1. CLI help shows new flags: `cocosearch search --help | grep -E '\-A|\-B|\-C|--no-smart'`
2. Formatter imports work: `python -c "from cocosearch.search.formatter import format_json, format_pretty"`
3. Unit tests pass: `python -m pytest tests/unit/search/test_formatter_context.py -v`
4. Context appears in output when flags used
</verification>

<success_criteria>
- CLI supports -A/-B/-C context flags matching grep conventions
- --no-smart flag disables smart boundary expansion
- JSON output includes context_before and context_after string fields
- Pretty output uses grep-style `:` and `>` line markers
- BOF/EOF markers shown when context hits file boundaries
- All formatter tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/31-context-expansion/31-02-SUMMARY.md`
</output>
