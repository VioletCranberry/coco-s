---
phase: 31-context-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cocosearch/search/context_expander.py
  - tests/unit/search/test_context_expander.py
autonomous: true

must_haves:
  truths:
    - "Smart boundary detection finds enclosing function or class"
    - "Context expander reads file lines efficiently with caching"
    - "Results respect 50-line hard limit"
  artifacts:
    - path: "src/cocosearch/search/context_expander.py"
      provides: "Smart context expansion with tree-sitter boundaries"
      exports: ["ContextExpander", "get_context_with_boundaries"]
    - path: "tests/unit/search/test_context_expander.py"
      provides: "Unit tests for context expansion"
      min_lines: 100
  key_links:
    - from: "src/cocosearch/search/context_expander.py"
      to: "tree-sitter parsers"
      via: "get_language from tree_sitter_languages"
      pattern: "get_language\\("
---

<objective>
Create the context expansion module with smart boundary detection using tree-sitter.

Purpose: Enable search results to show surrounding code context with intelligent function/class boundaries.
Output: New context_expander.py module with ContextExpander class and supporting tests.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-context-expansion/31-CONTEXT.md
@.planning/phases/31-context-expansion/31-RESEARCH.md
@src/cocosearch/indexer/symbols.py (tree-sitter parser patterns)
@src/cocosearch/search/utils.py (existing context functions to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create context_expander.py module</name>
  <files>src/cocosearch/search/context_expander.py</files>
  <action>
Create new module `src/cocosearch/search/context_expander.py` with:

1. **Imports:**
   - functools.lru_cache for file caching
   - linecache for efficient line access
   - tree_sitter_languages.get_language for parser initialization
   - logging for debug output

2. **Constants:**
   - MAX_CONTEXT_LINES = 50 (hard limit per CONTEXT.md)
   - LINE_TRUNCATION_LENGTH = 200 (per research recommendation)
   - DEFINITION_NODE_TYPES dict mapping language to enclosing scope types:
     - python: function_definition, class_definition
     - javascript: function_declaration, class_declaration, method_definition, arrow_function
     - typescript: same as JS + interface_declaration
     - go: function_declaration, method_declaration, type_declaration
     - rust: function_item, impl_item, struct_item, trait_item

3. **ContextExpander class:**
   ```python
   class ContextExpander:
       """Manages context expansion with caching."""

       def __init__(self):
           self._parsers: dict[str, Parser] = {}
           # Instance-level LRU cache via wrapper method

       def get_file_lines(self, filepath: str) -> list[str]:
           """Get file lines with LRU caching (max 128 files)."""

       def find_enclosing_scope(
           self, filepath: str, start_line: int, end_line: int, language: str
       ) -> tuple[int, int]:
           """Find enclosing function/class boundaries using tree-sitter."""

       def get_context_lines(
           self,
           filepath: str,
           start_line: int,
           end_line: int,
           context_before: int = 0,
           context_after: int = 0,
           smart: bool = True,
           language: str | None = None,
       ) -> tuple[list[tuple[int, str]], list[tuple[int, str]], list[tuple[int, str]], bool, bool]:
           """Get context lines with smart boundary expansion.

           Returns:
               Tuple of (before_lines, match_lines, after_lines, is_bof, is_eof)
               Each line is (line_number, line_text).
           """

       def clear_cache(self):
           """Clear file cache after search session."""
   ```

4. **Helper functions:**
   - `_get_language_from_path(filepath: str) -> str | None`: Extract language from file extension
   - `_truncate_line(line: str, max_length: int = 200) -> str`: Truncate with "..." suffix
   - `_byte_to_line_cached(content: bytes, byte_offset: int) -> int`: Convert byte to line

5. **find_enclosing_scope implementation:**
   - Get parser for language (cache parser instances)
   - Read file as bytes and parse with tree-sitter
   - Calculate byte offset from line number
   - Use tree.root_node.descendant_for_byte_range() to find node at position
   - Walk up parent chain looking for DEFINITION_NODE_TYPES
   - Convert node byte range back to line numbers
   - If no enclosing scope found, return original range
   - Wrap in try/except, return original range on any error

6. **get_context_lines implementation:**
   - Read file lines (cached)
   - If smart=True and language detected:
     - Call find_enclosing_scope to expand range
   - Apply 50-line hard limit centered on original match
   - Extract lines before, during, and after match
   - Check is_bof (before hits line 1) and is_eof (after hits last line)
   - Truncate long lines
   - Return structured result

7. **Error handling:**
   - FileNotFoundError: return empty lists with no context
   - Parse errors: log debug message, fall back to fixed line count
   - IOError: return empty lists
  </action>
  <verify>
File exists at src/cocosearch/search/context_expander.py with all classes and functions.
`python -c "from cocosearch.search.context_expander import ContextExpander, get_context_with_boundaries"` succeeds.
  </verify>
  <done>ContextExpander class exists with find_enclosing_scope, get_context_lines, and clear_cache methods.</done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for context expander</name>
  <files>tests/unit/search/test_context_expander.py</files>
  <action>
Create comprehensive tests at `tests/unit/search/test_context_expander.py`:

1. **Test fixtures:**
   - tmp_path fixture for temp files
   - Sample Python file with nested classes/functions
   - Sample JavaScript file with function and class
   - Sample non-code file (JSON)

2. **Test find_enclosing_scope:**
   - Test function boundary detection in Python
   - Test class boundary detection
   - Test method inside class
   - Test file with no enclosing scope (top-level code)
   - Test fallback on parse error (corrupted file)
   - Test unsupported language returns original range

3. **Test get_context_lines:**
   - Test smart=True expands to function boundaries
   - Test smart=False uses exact line counts
   - Test 50-line limit is enforced on large functions
   - Test BOF detection when context hits line 1
   - Test EOF detection when context hits last line
   - Test long line truncation at 200 chars
   - Test explicit context_before/context_after parameters

4. **Test caching:**
   - Test same file read returns cached content
   - Test clear_cache resets cache

5. **Test edge cases:**
   - Empty file
   - Binary file (utf-8 decode errors handled)
   - File not found returns empty results
   - Single-line file

All tests should use pytest and follow existing patterns in tests/unit/.
Mark tests with @pytest.mark.unit decorator.
  </action>
  <verify>`cd /Users/fedorzhdanov/GIT/personal/coco-s && python -m pytest tests/unit/search/test_context_expander.py -v` passes.</verify>
  <done>Unit tests exist and pass for ContextExpander with coverage of smart boundaries, caching, and edge cases.</done>
</task>

</tasks>

<verification>
1. Module imports work: `python -c "from cocosearch.search.context_expander import ContextExpander"`
2. Unit tests pass: `python -m pytest tests/unit/search/test_context_expander.py -v`
3. Smart boundary detection works for Python functions/classes
4. 50-line limit is enforced
5. Cache can be cleared
</verification>

<success_criteria>
- ContextExpander class implemented with smart boundary detection
- Tree-sitter integration finds enclosing function/class
- 50-line hard limit enforced
- File caching with LRU prevents repeated I/O
- Unit tests pass with good coverage
</success_criteria>

<output>
After completion, create `.planning/phases/31-context-expansion/31-01-SUMMARY.md`
</output>
