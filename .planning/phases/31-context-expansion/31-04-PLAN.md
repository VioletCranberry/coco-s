---
phase: 31-context-expansion
plan: 04
type: execute
wave: 3
depends_on: ["31-02", "31-03"]
files_modified:
  - src/cocosearch/search/__init__.py
  - tests/integration/test_context_e2e.py
autonomous: true

must_haves:
  truths:
    - "Context expansion works end-to-end with real files"
    - "Smart boundaries correctly detect Python functions and classes"
    - "Performance is acceptable (no repeated file reads)"
  artifacts:
    - path: "tests/integration/test_context_e2e.py"
      provides: "End-to-end tests for context expansion"
      min_lines: 100
    - path: "src/cocosearch/search/__init__.py"
      provides: "Updated exports including context_expander"
      contains: "ContextExpander"
  key_links:
    - from: "tests/integration/test_context_e2e.py"
      to: "CLI and MCP"
      via: "subprocess and function calls"
      pattern: "cocosearch search"
---

<objective>
Integration testing and final wiring for context expansion.

Purpose: Verify context expansion works end-to-end across CLI and MCP with real file I/O.
Output: Integration tests and updated module exports.
</objective>

<execution_context>
@/Users/fedorzhdanov/.claude/get-shit-done/workflows/execute-plan.md
@/Users/fedorzhdanov/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/31-context-expansion/31-CONTEXT.md
@.planning/phases/31-context-expansion/31-01-SUMMARY.md
@.planning/phases/31-context-expansion/31-02-SUMMARY.md
@.planning/phases/31-context-expansion/31-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update search module exports</name>
  <files>src/cocosearch/search/__init__.py</files>
  <action>
Update `src/cocosearch/search/__init__.py` to export ContextExpander:

1. Add import:
   ```python
   from cocosearch.search.context_expander import ContextExpander
   ```

2. Update __all__ list to include ContextExpander:
   ```python
   __all__ = [
       "search",
       "SearchResult",
       "byte_to_line",
       "read_chunk_content",
       "get_context_lines",
       "ContextExpander",  # Add this
   ]
   ```

This allows external code to import directly from cocosearch.search:
```python
from cocosearch.search import ContextExpander
```
  </action>
  <verify>`python -c "from cocosearch.search import ContextExpander; print(ContextExpander)"` succeeds.</verify>
  <done>ContextExpander is exported from cocosearch.search module.</done>
</task>

<task type="auto">
  <name>Task 2: Create integration tests for context expansion</name>
  <files>tests/integration/test_context_e2e.py</files>
  <action>
Create comprehensive integration tests at `tests/integration/test_context_e2e.py`:

1. **Test fixtures:**
   - Create temp directory with sample Python files containing classes and functions
   - Sample file structure:
     ```
     test_project/
       sample.py  # Contains class with methods, standalone function
       utils.py   # Contains nested functions
       data.json  # Non-code file
     ```

2. **Test CLI context flags (using subprocess):**
   - `cocosearch search -A 5 "query" --index test_index --pretty`
     - Verify output shows 5 lines after each match
   - `cocosearch search -B 3 "query" --index test_index`
     - Verify JSON has context_before with 3 lines
   - `cocosearch search -C 2 "query" --index test_index`
     - Verify both before and after have 2 lines
   - `cocosearch search --no-smart "query" --index test_index --pretty`
     - Verify no boundary expansion occurs

3. **Test smart boundary detection:**
   - Create Python file with:
     ```python
     def process_data(items):
         # Line 2
         result = []
         for item in items:
             result.append(transform(item))
         return result  # Line 7
     ```
   - Search for content in middle of function
   - Verify context expands to include full function (lines 1-7)
   - Verify 50-line limit is enforced on large functions

4. **Test performance (file caching):**
   - Index project with multiple files
   - Search returning multiple results from same file
   - Verify context expander reads file once (check logs or timing)
   - Use pytest caplog to verify no repeated file read logs

5. **Test edge cases:**
   - Search result from deleted file (should skip gracefully)
   - Search result at file boundaries (BOF/EOF markers)
   - Long lines truncated at 200 chars

6. **Test MCP context parameters:**
   - Call search_code directly with context_before=3, context_after=5
   - Verify response includes context fields
   - Call with smart_context=False
   - Verify no boundary expansion

Mark integration tests with @pytest.mark.integration.
Skip tests if required fixtures (database, index) not available.
  </action>
  <verify>`cd /Users/fedorzhdanov/GIT/personal/coco-s && python -m pytest tests/integration/test_context_e2e.py -v -m integration` passes (or skips if no integration env).</verify>
  <done>Integration tests verify context expansion works end-to-end.</done>
</task>

<task type="auto">
  <name>Task 3: Verify full feature integration</name>
  <files>tests/integration/test_context_e2e.py</files>
  <action>
Add comprehensive verification tests:

1. **Test complete user flow:**
   - Create temp codebase with known content
   - Index the codebase
   - Search with -C 10 --pretty
   - Verify grep-style output with `:` and `>` markers
   - Verify line numbers are correct
   - Verify BOF/EOF markers appear at boundaries

2. **Test JSON output format:**
   - Search with -A 5 -B 3
   - Parse JSON output
   - Verify context_before and context_after are strings
   - Verify line content matches source file

3. **Test smart vs explicit:**
   - Search same query with smart_context=True
   - Search same query with -C 5
   - Verify different context sizes returned

4. **Test batched I/O optimization:**
   - Create file with 1000 lines
   - Search returning 10 results from same file
   - Time the operation
   - Verify context expansion completes in reasonable time (<1s)

Add any necessary fixtures to conftest.py if shared with other integration tests.
  </action>
  <verify>`python -m pytest tests/integration/test_context_e2e.py -v` passes all context-related tests.</verify>
  <done>Full integration testing confirms context expansion feature works correctly.</done>
</task>

</tasks>

<verification>
1. Module export works: `python -c "from cocosearch.search import ContextExpander"`
2. Unit tests pass: `python -m pytest tests/unit/ -v`
3. Integration tests pass: `python -m pytest tests/integration/test_context_e2e.py -v -m integration`
4. Manual CLI test: `cocosearch search -C 5 "function" --index test --pretty` shows context
</verification>

<success_criteria>
- ContextExpander exported from cocosearch.search
- Integration tests verify CLI flags work (-A/-B/-C/--no-smart)
- Integration tests verify MCP parameters work
- Smart boundary detection correctly finds Python functions/classes
- Performance is acceptable (batched file reads)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/31-context-expansion/31-04-SUMMARY.md`
</output>
