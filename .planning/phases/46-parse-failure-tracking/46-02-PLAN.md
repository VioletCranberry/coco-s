---
phase: 46-parse-failure-tracking
plan: 02
type: execute
wave: 2
depends_on: ["46-01"]
files_modified:
  - src/cocosearch/management/stats.py
  - src/cocosearch/cli.py
autonomous: true

must_haves:
  truths:
    - "get_parse_stats() returns per-language breakdown with ok/partial/error/unsupported counts"
    - "get_parse_failures() returns individual file failure details for non-ok statuses"
    - "IndexStats includes parse_stats field populated by get_comprehensive_stats()"
    - "cocosearch stats CLI shows parse health percentage and per-language parse table"
    - "cocosearch stats --show-failures shows individual file failure details"
    - "Pre-phase-46 indexes gracefully show empty parse stats (no errors)"
  artifacts:
    - path: "src/cocosearch/management/stats.py"
      provides: "get_parse_stats(), get_parse_failures(), updated IndexStats and get_comprehensive_stats()"
      contains: "get_parse_stats"
    - path: "src/cocosearch/cli.py"
      provides: "format_parse_health(), --show-failures flag, parse health display in stats_command"
      contains: "format_parse_health"
  key_links:
    - from: "src/cocosearch/management/stats.py"
      to: "cocosearch_parse_results_{index_name}"
      via: "SQL queries for parse status aggregation"
      pattern: "cocosearch_parse_results"
    - from: "src/cocosearch/management/stats.py"
      to: "src/cocosearch/management/stats.py::IndexStats"
      via: "parse_stats field added to IndexStats dataclass"
      pattern: "parse_stats"
    - from: "src/cocosearch/cli.py"
      to: "src/cocosearch/management/stats.py"
      via: "get_comprehensive_stats().parse_stats used in stats_command"
      pattern: "parse_stats"
---

<objective>
Build the stats aggregation layer and CLI display for parse failure tracking. Add query functions to stats.py, extend IndexStats, and update the CLI stats command with parse health display and --show-failures flag.

Purpose: Users need to see parse health when running `cocosearch stats`. This plan creates the query functions and the primary user-facing display.
Output: Updated stats.py with parse query functions, updated cli.py with parse health formatting and --show-failures flag.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/46-parse-failure-tracking/46-CONTEXT.md
@.planning/phases/46-parse-failure-tracking/46-RESEARCH.md
@.planning/phases/46-parse-failure-tracking/46-01-SUMMARY.md
@src/cocosearch/management/stats.py
@src/cocosearch/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add parse stats query functions and extend IndexStats</name>
  <files>src/cocosearch/management/stats.py</files>
  <action>
Add two new query functions and update the IndexStats dataclass and get_comprehensive_stats:

**1. `get_parse_stats(index_name: str) -> dict`**

Returns aggregated parse stats per language. Structure:
```python
{
    "by_language": {
        "python": {"files": 142, "ok": 138, "partial": 3, "error": 1, "unsupported": 0},
        "javascript": {"files": 50, "ok": 50, "partial": 0, "error": 0, "unsupported": 0},
    },
    "parse_health_pct": 95.2,
    "total_files": 192,
    "total_ok": 188,
}
```

Implementation:
- Table name: `cocosearch_parse_results_{index_name}`
- Use `get_connection_pool()` (already imported)
- First check if table exists using `information_schema.tables` query with `table_schema = 'public'` (same pattern as `get_stats()`)
- If table doesn't exist, return empty dict `{}` (graceful degradation for pre-v46 indexes)
- Run aggregation: `SELECT language, parse_status, COUNT(*) FROM {table_name} GROUP BY language, parse_status ORDER BY language, parse_status`
- Build `by_language` dict: for each row, initialize language entry if not present with `{"files": 0, "ok": 0, "partial": 0, "error": 0, "unsupported": 0}`, increment the status count and files total
- Calculate `parse_health_pct = round((total_ok / total_files * 100), 1) if total_files > 0 else 100.0`
- Return the full dict

**2. `get_parse_failures(index_name: str, status_filter: list[str] | None = None) -> list[dict]`**

Returns individual file failure details for `--show-failures` CLI flag and MCP/HTTP optional detail.

- Default `status_filter` is `["partial", "error", "unsupported"]` (non-ok statuses)
- Table name: `cocosearch_parse_results_{index_name}`
- Check table existence first (same pattern). If not found, return `[]`.
- Query: `SELECT file_path, language, parse_status, error_message FROM {table_name} WHERE parse_status = ANY(%s) ORDER BY language, parse_status, file_path`
- Return list of dicts: `[{"file_path": str, "language": str, "parse_status": str, "error_message": str | None}, ...]`

**3. Update `IndexStats` dataclass:**

Add a new field `parse_stats: dict` after the `warnings` field. Default value is `{}` (supports pre-v46 indexes).

Update the field declaration:
```python
parse_stats: dict  # Parse failure breakdown per language (empty dict for pre-v46 indexes)
```

Note: Since IndexStats uses `asdict()` in `to_dict()`, the `parse_stats` dict will automatically be included in JSON serialization. No changes to `to_dict()` needed.

**4. Update `get_comprehensive_stats()`:**

After `symbols = get_symbol_stats(index_name)` and before `is_stale, staleness_days = check_staleness(...)`, add:
```python
# Get parse failure stats
parse_stats = get_parse_stats(index_name)
```

Add `parse_stats=parse_stats` to the `IndexStats(...)` constructor call at the bottom of the function.

**5. Update management/__init__.py** (if needed):

Check if `get_parse_stats` and `get_parse_failures` need to be exported. They will be used by cli.py and mcp/server.py. Add them to the imports in `management/__init__.py`:
```python
from cocosearch.management.stats import get_comprehensive_stats, get_language_stats, get_parse_failures, get_parse_stats, get_stats
```
And add `"get_parse_failures"` and `"get_parse_stats"` to the `__all__` list.
  </action>
  <verify>
Run `python -c "from cocosearch.management.stats import get_parse_stats, get_parse_failures, IndexStats; print('stats imports ok')"` to verify all new functions and updated dataclass import.

Run `python -c "
from cocosearch.management.stats import IndexStats
from datetime import datetime, timezone
# Verify parse_stats field exists on IndexStats
stats = IndexStats(
    name='test', file_count=10, chunk_count=50,
    storage_size=1024, storage_size_pretty='1.0 KB',
    created_at=None, updated_at=None,
    is_stale=False, staleness_days=0,
    languages=[], symbols={}, warnings=[],
    parse_stats={'by_language': {}, 'parse_health_pct': 100.0, 'total_files': 0, 'total_ok': 0}
)
d = stats.to_dict()
assert 'parse_stats' in d, 'parse_stats missing from to_dict()'
assert d['parse_stats']['parse_health_pct'] == 100.0
print('IndexStats with parse_stats works')
"` to verify the updated dataclass.

Run `python -c "from cocosearch.management import get_parse_stats, get_parse_failures; print('management exports ok')"` to verify module exports.
  </verify>
  <done>
  - get_parse_stats() returns per-language aggregation with parse_health_pct
  - get_parse_failures() returns individual file failure details
  - IndexStats has parse_stats field
  - get_comprehensive_stats() populates parse_stats
  - Functions exported from management/__init__.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CLI stats_command with parse health display and --show-failures flag</name>
  <files>src/cocosearch/cli.py</files>
  <action>
**1. Add `format_parse_health()` function** (place after `format_symbol_table()`, before `stats_command()`):

```python
def format_parse_health(parse_stats: dict, console: Console) -> None:
    """Display parse health summary and per-language breakdown."""
    if not parse_stats:
        return

    pct = parse_stats.get("parse_health_pct", 100.0)
    total = parse_stats.get("total_files", 0)
    ok = parse_stats.get("total_ok", 0)

    # Summary line with color coding
    color = "green" if pct >= 95 else "yellow" if pct >= 80 else "red"
    console.print(f"\n[{color}]Parse health: {pct}% clean ({ok}/{total} files)[/{color}]")

    # Per-language table
    from rich.table import Table
    table = Table(title="Parse Status by Language")
    table.add_column("Language", style="cyan")
    table.add_column("Files", justify="right")
    table.add_column("OK", justify="right", style="green")
    table.add_column("Partial", justify="right", style="yellow")
    table.add_column("Error", justify="right", style="red")
    table.add_column("Unsupported", justify="right", style="dim")

    for lang, counts in sorted(parse_stats.get("by_language", {}).items()):
        table.add_row(
            lang,
            str(counts["files"]),
            str(counts["ok"]),
            str(counts["partial"]),
            str(counts["error"]),
            str(counts["unsupported"]),
        )
    console.print(table)
```

**2. Add `format_parse_failures()` function** (place after `format_parse_health()`):

```python
def format_parse_failures(failures: list[dict], console: Console) -> None:
    """Display individual file parse failure details."""
    if not failures:
        console.print("\n[dim]No parse failures found[/dim]")
        return

    from rich.table import Table
    table = Table(title="Parse Failures")
    table.add_column("File", style="white", no_wrap=True)
    table.add_column("Language", style="cyan")
    table.add_column("Status", style="yellow")
    table.add_column("Error", style="red", max_width=60)

    for f in failures:
        status_style = "red" if f["parse_status"] == "error" else "yellow" if f["parse_status"] == "partial" else "dim"
        table.add_row(
            f["file_path"],
            f["language"],
            f"[{status_style}]{f['parse_status']}[/{status_style}]",
            f.get("error_message") or "",
        )
    console.print(table)
```

**3. Add `--show-failures` flag** to stats parser:

In the `main()` function, after the existing `stats_parser.add_argument("--refresh-interval", ...)` line, add:
```python
stats_parser.add_argument(
    "--show-failures",
    action="store_true",
    help="Show individual file parse failure details",
)
```

**4. Update `stats_command()`** to display parse health:

In the single-index pretty output section (after the symbol statistics block, around line 670-677), add:

```python
        # Parse health (always shown if available)
        if stats.parse_stats:
            format_parse_health(stats.parse_stats, console)

        # Parse failure details (only with --show-failures flag)
        if args.show_failures and stats.parse_stats:
            from cocosearch.management.stats import get_parse_failures
            failures = get_parse_failures(index_name)
            format_parse_failures(failures, console)
        elif args.show_failures and not stats.parse_stats:
            console.print("\n[dim]No parse statistics available (requires re-indexing with v1.10+)[/dim]")
```

Also add the same parse health display to the `--all` output path (inside the `for i, stats in enumerate(all_stats):` loop, after the symbol statistics block):

```python
                    # Parse health
                    if stats.parse_stats:
                        format_parse_health(stats.parse_stats, console)
```

**5. Update JSON output path:**

In the JSON output paths (both single-index and `--all`), the parse_stats is already included via `stats.to_dict()` since we added the field to IndexStats. No changes needed for JSON output.

If `--show-failures` is passed with `--json`, include failure details in the JSON. In the single-index JSON block:
```python
    if json_output:
        # JSON output
        data = stats.to_dict()
        if args.show_failures:
            from cocosearch.management.stats import get_parse_failures
            data["parse_failures"] = get_parse_failures(index_name)
        print(json.dumps(data, indent=2))
```

Replace the existing `print(json.dumps(stats.to_dict(), indent=2))` line with this block.
  </action>
  <verify>
Run `python -c "from cocosearch.cli import format_parse_health, format_parse_failures; print('cli imports ok')"` to verify the new functions are importable.

Run `python -c "
import cocosearch.cli as cli
import argparse
# Check --show-failures argument exists on stats parser
parser = argparse.ArgumentParser()
sub = parser.add_subparsers()
stats = sub.add_parser('stats')
# The actual parsing happens in main(), so just verify the file loads
print('cli module loads ok')
"` to verify the module loads.

Run `grep -n 'show.failures\|format_parse_health\|format_parse_failures\|parse_stats' src/cocosearch/cli.py | head -20` to confirm all parse-related additions are present.
  </verify>
  <done>
  - format_parse_health() displays color-coded parse health summary and per-language table
  - format_parse_failures() displays individual file failure details
  - --show-failures flag added to stats parser
  - stats_command() displays parse health in both single-index and --all modes
  - JSON output includes parse_stats and optional parse_failures
  </done>
</task>

</tasks>

<verification>
1. `get_parse_stats()` and `get_parse_failures()` are importable from management.stats
2. `IndexStats` has `parse_stats` field, and `to_dict()` serializes it
3. `get_comprehensive_stats()` populates the parse_stats field
4. CLI `stats_command` displays parse health in pretty mode
5. CLI `--show-failures` flag is registered and triggers failure detail display
6. JSON output includes parse_stats via to_dict()
7. Pre-v46 indexes show no parse stats (empty dict) without errors
</verification>

<success_criteria>
- stats.py has get_parse_stats() and get_parse_failures() with table existence checks
- IndexStats includes parse_stats field
- get_comprehensive_stats() calls get_parse_stats() and passes to IndexStats
- cli.py has format_parse_health() and format_parse_failures() functions
- --show-failures flag registered on stats parser
- stats_command() displays parse health and optional failure details
</success_criteria>

<output>
After completion, create `.planning/phases/46-parse-failure-tracking/46-02-SUMMARY.md`
</output>
