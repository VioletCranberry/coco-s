---
phase: 44-docker-image-simplification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/Dockerfile
  - docker/.dockerignore
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/run
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/type
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/init-warmup
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/svc-ollama
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/svc-postgresql
  - docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/svc-mcp
  - docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/svc-postgresql
  - docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/init-warmup
  - docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-mcp
  - docker/rootfs/etc/s6-overlay/scripts/health-check
  - docker/rootfs/etc/s6-overlay/scripts/ready-signal
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/run
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/finish
  - docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/data/check
autonomous: true

must_haves:
  truths:
    - "Docker image builds without Python builder stage and contains no CocoSearch application code"
    - "Container s6 service tree has no svc-mcp references anywhere"
    - "Health check reports healthy when PostgreSQL and Ollama are ready (no MCP check)"
    - "Container exposes only ports 5432 and 11434 (not 3000)"
    - "init-ready fires only after both PostgreSQL and Ollama warmup are complete"
    - "All PostgreSQL paths reference version 17 (not 16)"
  artifacts:
    - path: "docker/Dockerfile"
      provides: "Infrastructure-only Docker image definition"
      contains: "debian:bookworm-slim"
    - path: "docker/rootfs/etc/s6-overlay/scripts/health-check"
      provides: "Health check for PostgreSQL and Ollama only"
      contains: "postgresql/17"
    - path: "docker/rootfs/etc/s6-overlay/scripts/ready-signal"
      provides: "Ready signal without MCP references"
      contains: "CocoSearch infrastructure ready"
  key_links:
    - from: "docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/"
      to: "svc-postgresql and init-warmup"
      via: "empty marker files"
      pattern: "svc-postgresql|init-warmup"
    - from: "docker/Dockerfile"
      to: "debian:bookworm-slim"
      via: "FROM directive"
      pattern: "FROM debian:bookworm-slim"
---

<objective>
Strip all CocoSearch application code from the Docker image, making it infrastructure-only (PostgreSQL+pgvector and Ollama+model). Remove the Python builder stage, delete the svc-mcp s6 service, rewire init-ready dependencies, upgrade PostgreSQL 16 to 17, and update health-check and ready-signal scripts.

Purpose: The Docker image should provide only infrastructure services. CocoSearch runs natively via uvx.
Output: A simplified Dockerfile and s6-overlay service tree with no Python, no MCP server, no port 3000.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-docker-image-simplification/44-RESEARCH.md
@docker/Dockerfile
@docker/rootfs/etc/s6-overlay/scripts/health-check
@docker/rootfs/etc/s6-overlay/scripts/ready-signal
@docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/run
@docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/
@docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/
@docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/run
@docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/finish
@docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/data/check
@docker/.dockerignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite Dockerfile to infrastructure-only</name>
  <files>docker/Dockerfile, docker/.dockerignore</files>
  <action>
  Rewrite docker/Dockerfile to remove all CocoSearch application code. The operation is purely subtractive plus a base image change and PG version bump. Make these specific changes:

  **Remove entirely:**
  - Stage 2 (python-builder): Lines 20-36 — the entire `FROM python:3.11-slim AS python-builder` block
  - `COPY --from=python-builder` lines (lines 98-99 in current file)
  - `/app/.venv/bin` from PATH env (line 102) — keep only `/usr/lib/postgresql/17/bin:$PATH`
  - `PYTHONPATH="/app/src"` env (line 103)
  - `COCOSEARCH_MCP_PORT=3000` from ENV block (line 122)
  - `COCOSEARCH_MCP_TRANSPORT=http` from ENV block (line 126)
  - `COCOSEARCH_LOG_LEVEL=warn` from ENV block (line 127)
  - Port `3000` from EXPOSE (line 147) — keep only `5432 11434`
  - `git` from apt-get install (line 77) — was only needed for Python package builds

  **Change:**
  - Header comment (lines 1-6): Replace "All-in-One" with "Infrastructure" image. Update description to "Bundles PostgreSQL+pgvector and Ollama with pre-baked nomic-embed-text model". Remove MCP server reference. Change run command to: `docker run -v cocosearch-data:/data -p 5432:5432 -p 11434:11434 cocosearch`
  - Stage 3 base image (line 41): `FROM python:3.11-slim` to `FROM debian:bookworm-slim`
  - Labels (lines 43-44): Change title to "CocoSearch Infrastructure", description to "PostgreSQL+pgvector and Ollama for CocoSearch"
  - PostgreSQL packages (lines 82-84): `postgresql-16` to `postgresql-17`, `postgresql-16-pgvector` to `postgresql-17-pgvector`
  - Comment on line 69: "Install PostgreSQL 16" to "Install PostgreSQL 17"
  - PATH env (line 102): Change to `ENV PATH="/usr/lib/postgresql/17/bin:$PATH"` (remove /app/.venv/bin, update 16->17)
  - Remove the `/mnt/repos` directory creation from `mkdir -p` (line 117) — no app code will mount repos. Keep `/data/pg_data /data/ollama_models /data/cocosearch`

  **Keep unchanged:** Stage 1 (model-downloader), s6-overlay install block, Ollama binary copy, pre-baked model copy, HEALTHCHECK, STOPSIGNAL, ENTRYPOINT. All environment variables listed as KEEP in research (COCOSEARCH_PG_PORT, COCOSEARCH_OLLAMA_PORT, COCOSEARCH_EMBED_MODEL, COCOSEARCH_DATABASE_URL, OLLAMA_HOST, OLLAMA_MODELS, PGDATA, HOME, S6_KILL_GRACETIME, S6_SERVICES_GRACETIME).

  **Simplify docker/.dockerignore:** Remove Python-specific exclusions that no longer apply (pyproject.toml, uv.lock, src/, *.egg-info etc are no longer copied). The .dockerignore can be simplified since only `docker/rootfs/` is copied into the build context. Keep exclusions that prevent bloating the build context: .git, .planning, tests, docs, .venv, venv, .env, IDE files, OS files. Remove: `!README.md` exception (README.md is no longer COPY'd into the image).
  </action>
  <verify>
  1. Run `grep -c "python-builder" docker/Dockerfile` — must return 0
  2. Run `grep -c "python:3.11" docker/Dockerfile` — must return 0
  3. Run `grep "^FROM" docker/Dockerfile` — must show exactly 2 FROM lines: `ollama/ollama:latest` and `debian:bookworm-slim`
  4. Run `grep "EXPOSE" docker/Dockerfile` — must show `5432 11434` only (no 3000)
  5. Run `grep "postgresql/16" docker/Dockerfile` — must return nothing (all updated to 17)
  6. Run `grep "MCP" docker/Dockerfile` — must return nothing
  7. Run `grep "PYTHONPATH" docker/Dockerfile` — must return nothing
  8. Run `grep "LOG_LEVEL" docker/Dockerfile` — must return nothing
  </verify>
  <done>
  Dockerfile has exactly 2 stages (model-downloader, debian:bookworm-slim runtime). No Python builder stage, no COPY --from=python-builder, no /app/.venv, no PYTHONPATH, no MCP env vars, no port 3000. PostgreSQL packages are version 17. Base image is debian:bookworm-slim. .dockerignore is simplified.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove svc-mcp, rewire init-ready, update scripts and PG paths</name>
  <files>
  docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/run,
  docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/type,
  docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/init-warmup,
  docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/svc-ollama,
  docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/dependencies.d/svc-postgresql,
  docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/svc-mcp,
  docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/svc-postgresql,
  docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/init-warmup,
  docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-mcp,
  docker/rootfs/etc/s6-overlay/scripts/health-check,
  docker/rootfs/etc/s6-overlay/scripts/ready-signal,
  docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/run,
  docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/finish,
  docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/data/check
  </files>
  <action>
  **Delete the entire svc-mcp directory tree (5 files):**
  ```
  rm -rf docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp/
  ```

  **Delete the 2 external svc-mcp references:**
  ```
  rm docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/svc-mcp
  rm docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/svc-mcp
  ```

  **Rewire init-ready dependencies** (create 2 empty marker files):
  ```
  touch docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/svc-postgresql
  touch docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/init-warmup
  ```
  This ensures init-ready waits for both PostgreSQL readiness and Ollama model warmup (init-warmup transitively depends on svc-ollama).

  **Verify no orphaned references:**
  Run `find docker/rootfs -name "*mcp*"` and confirm it returns nothing.

  **Update health-check script** (`docker/rootfs/etc/s6-overlay/scripts/health-check`):
  Remove lines 20-24 (the MCP server health check block). Update line 6 PATH from `postgresql/16` to `postgresql/17`. Update the comment on line 2 to say "infrastructure services" instead of "ALL services". Target content:
  ```sh
  #!/bin/sh
  # Combined health check - returns 0 only when infrastructure services are ready
  # Used by Docker HEALTHCHECK

  # Add PostgreSQL binaries to PATH
  export PATH="/usr/lib/postgresql/17/bin:$PATH"

  # Check PostgreSQL
  if ! pg_isready -h localhost -U cocosearch -d cocosearch > /dev/null 2>&1; then
      echo "PostgreSQL not ready"
      exit 1
  fi

  # Check Ollama
  if ! curl -sf http://localhost:${COCOSEARCH_OLLAMA_PORT:-11434}/api/tags > /dev/null 2>&1; then
      echo "Ollama not ready"
      exit 1
  fi

  # All services ready
  exit 0
  ```

  **Update ready-signal script** (`docker/rootfs/etc/s6-overlay/scripts/ready-signal`):
  Remove MCP Server and Transport lines (lines 11-12). Update header comment (line 3): "AFTER all infrastructure services are ready" instead of "AFTER all services are ready (depends on svc-mcp which depends on everything)". Change "container ready" (line 7) to "infrastructure ready". Target content:
  ```sh
  #!/bin/sh
  # Print ready marker to stdout for scripting integration
  # This runs AFTER all infrastructure services are ready

  echo "=========================================="
  echo "CocoSearch infrastructure ready"
  echo "=========================================="
  echo "PostgreSQL:  localhost:${COCOSEARCH_PG_PORT:-5432}"
  echo "Ollama:      localhost:${COCOSEARCH_OLLAMA_PORT:-11434}"
  echo "=========================================="
  echo ""
  echo "COCOSEARCH_READY"
  echo ""
  ```

  **Update PostgreSQL 16 to 17 PATH in 3 s6-rc files:**
  1. `docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/run` — line 5: change `postgresql/16` to `postgresql/17`
  2. `docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/finish` — line 3: change `postgresql/16` to `postgresql/17`
  3. `docker/rootfs/etc/s6-overlay/s6-rc.d/svc-postgresql/data/check` — line 2: change `postgresql/16` to `postgresql/17`
  </action>
  <verify>
  1. Run `find docker/rootfs -name "*mcp*"` — must return nothing
  2. Run `ls docker/rootfs/etc/s6-overlay/s6-rc.d/svc-mcp` — must fail (directory does not exist)
  3. Run `ls docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/` — must show exactly `init-warmup` and `svc-postgresql` (no svc-mcp)
  4. Run `ls docker/rootfs/etc/s6-overlay/s6-rc.d/user/contents.d/` — must show `init-ready`, `init-warmup`, `svc-ollama`, `svc-postgresql` (no svc-mcp)
  5. Run `grep -r "mcp" docker/rootfs/` — must return nothing
  6. Run `grep -r "postgresql/16" docker/rootfs/` — must return nothing (all updated to 17)
  7. Run `grep "3000" docker/rootfs/etc/s6-overlay/scripts/health-check` — must return nothing
  8. Run `grep "MCP" docker/rootfs/etc/s6-overlay/scripts/ready-signal` — must return nothing
  </verify>
  <done>
  The svc-mcp directory is fully deleted. No file anywhere in docker/rootfs references "mcp". init-ready depends on svc-postgresql and init-warmup. Health check only checks PostgreSQL (pg_isready) and Ollama (curl). Ready-signal shows only PostgreSQL and Ollama endpoints. All 5 PostgreSQL PATH references updated from 16 to 17.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify the full phase success criteria:

1. `grep -c "python-builder" docker/Dockerfile` returns 0
2. `grep -r "mcp" docker/rootfs/` returns nothing
3. `grep -r "postgresql/16" docker/` returns nothing (all updated to 17)
4. `grep "EXPOSE" docker/Dockerfile` shows `5432 11434` only
5. `find docker/rootfs -name "*mcp*"` returns nothing
6. `ls docker/rootfs/etc/s6-overlay/s6-rc.d/init-ready/dependencies.d/` shows `init-warmup svc-postgresql`
7. `grep "debian:bookworm-slim" docker/Dockerfile` returns a match
</verification>

<success_criteria>
- Dockerfile has 2 stages (model-downloader + debian:bookworm-slim runtime), no Python
- Zero references to svc-mcp, MCP, port 3000, or Python in all docker/ files
- PostgreSQL version 17 throughout (packages, PATH in 5 locations)
- init-ready depends on svc-postgresql + init-warmup (not svc-mcp)
- Health check validates PostgreSQL and Ollama only
- Ready-signal shows infrastructure services only
</success_criteria>

<output>
After completion, create `.planning/phases/44-docker-image-simplification/44-01-SUMMARY.md`
</output>
