# Milestone v1.6: All-in-One Docker & Auto-Detect

**Status:** SHIPPED 2026-02-02
**Phases:** 23-26
**Total Plans:** 11

## Overview

Single `docker run` experience with all services bundled (PostgreSQL+pgvector, Ollama with pre-baked model, MCP server under s6-overlay process supervision), plus auto-detect project from working directory for seamless CLI agent integration.

## Phases

### Phase 23: MCP Transport Integration

**Goal**: MCP server supports multiple transport protocols selectable at runtime
**Depends on**: Phase 22 (v1.5 complete)
**Requirements**: TRNS-01, TRNS-02, TRNS-03, TRNS-04
**Status**: Complete (2026-02-01)
**Plans**: 2 plans

Plans:
- [x] 23-01-PLAN.md - Multi-transport support in server and CLI
- [x] 23-02-PLAN.md - Unit tests for transport selection

**Details:**
- Extended run_server() with transport, host, port parameters
- Added health endpoint at /health via FastMCP custom_route
- Added --transport and --port CLI flags to mcp subcommand
- Transport validation with environment variable fallbacks (MCP_TRANSPORT, COCOSEARCH_MCP_PORT)

### Phase 24: Container Foundation

**Goal**: All-in-one Docker container with PostgreSQL, Ollama, and MCP server under process supervision
**Depends on**: Phase 23
**Requirements**: DOCK-01 through DOCK-06, ORCH-01 through ORCH-04
**Status**: Complete (2026-02-02)
**Plans**: 4 plans

Plans:
- [x] 24-01-PLAN.md - Multi-stage Dockerfile with s6-overlay, PostgreSQL, Ollama, Python app
- [x] 24-02-PLAN.md - s6-overlay service definitions with dependency ordering
- [x] 24-03-PLAN.md - Health check and ready signal infrastructure
- [x] 24-04-PLAN.md - End-to-end verification and .dockerignore

**Details:**
- Multi-stage Dockerfile building in ~5 minutes with all components bundled
- nomic-embed-text model pre-baked into image (274MB, no runtime download)
- s6-overlay v3.2.2.0 as PID 1 with proper architecture mapping for arm64/amd64
- Service dependency chain: PostgreSQL -> Ollama -> warmup -> MCP
- Graceful shutdown with SIGTERM cascading through s6-overlay

### Phase 25: Auto-Detect Feature

**Goal**: MCP automatically detects project context from working directory
**Depends on**: Phase 23 (transport layer, not container)
**Requirements**: AUTO-01 through AUTO-06
**Status**: Complete (2026-02-02)
**Plans**: 4 plans

Plans:
- [x] 25-01-PLAN.md - Context detection and metadata storage foundation
- [x] 25-02-PLAN.md - MCP auto-detect integration
- [x] 25-03-PLAN.md - CLI path registration and cleanup
- [x] 25-04-PLAN.md - Unit tests for auto-detect feature

**Details:**
- Project root detection walking up directory tree via .git or cocosearch.yaml
- Symlink resolution using pathlib.Path.resolve() for consistent canonical paths
- Priority chain: cocosearch.yaml indexName > directory name
- Metadata storage in PostgreSQL with collision detection
- LRU caching for efficient path lookups in MCP tools

### Phase 26: Documentation & Polish

**Goal**: Complete documentation for Docker deployment and MCP client configuration
**Depends on**: Phase 24, Phase 25
**Requirements**: DOCS-01 through DOCS-05
**Status**: Complete (2026-02-02)
**Plans**: 1 plan

Plans:
- [x] 26-01-PLAN.md - Docker quick start, MCP client configuration, and troubleshooting documentation

**Details:**
- Docker Quick Start section with copy-paste examples
- Claude Code (stdio) and Claude Desktop (HTTP via mcp-remote) configuration
- Data persistence documentation for named volumes and repo-local storage
- Component-based troubleshooting guide (PostgreSQL, Ollama, MCP)

---

## Milestone Summary

**Key Decisions:**
- Configure FastMCP via mcp.settings instead of constructor params for dynamic host/port
- Use s6-overlay v3.2.2.0 for PID 1 process supervision (not supervisord)
- Map TARGETARCH to s6-overlay naming (arm64->aarch64, amd64->x86_64)
- Use official ollama/ollama image for multi-arch model baking
- Store canonical paths as TEXT in PostgreSQL
- Use mcp-remote as bridge for Claude Desktop HTTP-to-stdio conversion

**Issues Resolved:**
- FastMCP API mismatch: settings modification instead of run() params
- Multi-arch support: architecture mapping for s6-overlay and official Ollama image
- Symlink handling: resolve before walking tree for consistent paths

**Issues Deferred:**
- DOCK-07: Multi-arch images (linux/amd64, linux/arm64) publishing
- AUTO-07: Init-time auto-indexing of mounted codebases
- AUTO-08: Progress/status API for long indexing operations

**Technical Debt Incurred:**
None.

---

_For current project status, see .planning/ROADMAP.md_
