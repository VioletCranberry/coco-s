#!/bin/sh
# Preload embedding model into memory with a warmup request
MODEL="${COCOSEARCH_EMBED_MODEL:-nomic-embed-text}"

echo "Warming up Ollama model: $MODEL"

# Retry logic for warmup
MAX_RETRIES=3
RETRY=0

while [ $RETRY -lt $MAX_RETRIES ]; do
    if curl -sf http://localhost:11434/api/embeddings \
        -d "{\"model\": \"$MODEL\", \"prompt\": \"warmup\"}" > /dev/null 2>&1; then
        echo "Ollama model warm-up complete"
        exit 0
    fi
    RETRY=$((RETRY + 1))
    echo "Warmup attempt $RETRY failed, retrying..."
    sleep 2
done

echo "Warning: Ollama warmup failed after $MAX_RETRIES attempts"
# Don't fail - model will be loaded on first real request
exit 0
